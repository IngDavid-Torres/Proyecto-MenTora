<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin | MenTora</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Exo+2:wght@600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="/" class="logo">
            <img src="/static/img/mentora1.png" alt="MenTora Logo" onerror="this.src='/static/img/mentora.png'">
            <span>MENTORA ADMIN</span>
        </a>
        <button id="navToggle" class="menu-button" aria-label="Abrir menú">
            <i class="fas fa-bars" id="menuIconOpen"></i>
            <i class="fas fa-times" id="menuIconClose" style="display: none;"></i>
        </button>
        <div class="nav-wrapper" id="navWrapper">
            <ul class="nav-links" id="navLinks">
                <li><a href="#seccion-estadisticas"><i class="fa-solid fa-chart-bar"></i> <span>Estadísticas</span></a></li>
                <li><a href="#seccion-usuarios"><i class="fa-solid fa-users"></i> <span>Usuarios</span></a></li>
                <li><a href="#seccion-juegos"><i class="fa-solid fa-gamepad"></i> <span>Juegos</span></a></li>
                <li><a href="#seccion-quizzes"><i class="fa-solid fa-clipboard-question"></i> <span>Quizzes</span></a></li>
                <li><a href="#seccion-preguntas"><i class="fa-solid fa-circle-question"></i> <span>Preguntas</span></a></li>
                <li><a href="#seccion-logros"><i class="fa-solid fa-trophy"></i> <span>Logros</span></a></li>
                <li><a href="#seccion-reportes"><i class="fa-solid fa-chart-line"></i> <span>Reportes</span></a></li>
                <li><a href="#seccion-mensajes"><i class="fa-solid fa-envelope"></i> <span>Mensajes</span></a></li>
                <li><a href="#seccion-seguridad"><i class="fa-solid fa-lock"></i> <span>Seguridad</span></a></li>
                <li>
                    <form id="logoutForm" method="POST" action="/logout" style="margin:0;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button id="logoutBtn" class="logout-btn-nav" type="button"><i class="fa-solid fa-sign-out-alt"></i> <span>Cerrar Sesión</span></button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Overlay para menú móvil -->
    <div id="navOverlay" class="nav-overlay"></div>

    <!-- Modal de confirmación de logout -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <h3><i class="fa-solid fa-sign-out-alt"></i> ¿Seguro que quieres cerrar sesión?</h3>
            <p>Tu sesión se cerrará y deberás volver a iniciar sesión para acceder de nuevo.</p>
            <div style="display:flex; gap:var(--spacing-md); justify-content:center; flex-wrap:wrap;">
                <button id="confirmLogout" class="btn" style="background:#e74c3c;"><i class="fa-solid fa-check"></i> Sí, cerrar sesión</button>
                <button id="cancelLogout" class="btn" style="background:var(--text-gray);"><i class="fa-solid fa-times"></i> Cancelar</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1><i class="fa-solid fa-user-shield"></i> PANEL DE ADMINISTRACIÓN</h1>

        <!-- Estadísticas -->
        <section id="seccion-estadisticas">
            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <i class="fa-solid fa-users"></i>
                    <div class="count">{{ total_users|default(0) }}</div>
                    <div class="label">Usuarios</div>
                </div>
                <div class="dashboard-card">
                    <i class="fa-solid fa-clipboard-question"></i>
                    <div class="count">{{ total_quizzes|default(0) }}</div>
                    <div class="label">Quizzes</div>
                </div>
                <div class="dashboard-card">
                    <i class="fa-solid fa-circle-question"></i>
                    <div class="count">{{ total_questions|default(0) }}</div>
                    <div class="label">Preguntas</div>
                </div>
            </div>

            <div class="section">
                <h2><i class="fa-solid fa-chart-pie"></i> Estadísticas Generales</h2>
                <div style="display:flex; flex-wrap:wrap; gap:var(--spacing-lg); align-items:center; justify-content:center;">
                    <div style="flex:1; min-width:260px;">
                        <canvas id="statsBarChart" height="180"></canvas>
                    </div>
                    <div style="flex:1; min-width:260px;">
                        <canvas id="statsPieChart" height="180"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Usuarios -->
        <section id="seccion-usuarios">
            <div class="section">
                <h2><i class="fa-solid fa-user-friends"></i> Gestión de Usuarios</h2>
                <form method="POST" action="/admin/create_or_update_user" class="admin-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="user_id" value="{{ user_to_edit.id if user_to_edit else '' }}">
                    <div>
                        <label for="username">Usuario:</label>
                        <input type="text" id="username" name="username" required value="{{ user_to_edit.username if user_to_edit else '' }}">
                    </div>
                    <div>
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" required value="{{ user_to_edit.email if user_to_edit else '' }}">
                    </div>
                    <div>
                        <label for="area">Área:</label>
                        <input type="text" id="area" name="area" required value="{{ user_to_edit.area if user_to_edit else '' }}">
                    </div>
                    <div>
                        <label for="points">Puntos:</label>
                        <input type="number" id="points" name="points" min="0" value="{{ user_to_edit.points if user_to_edit else 0 }}">
                    </div>
                    <div>
                        <label for="level">Nivel:</label>
                        <input type="number" id="level" name="level" min="1" value="{{ user_to_edit.level if user_to_edit else 1 }}">
                    </div>
                    <div>
                        <label for="password">Contraseña:</label>
                        <input type="password" id="password" name="password" {% if not user_to_edit %}required{% endif %} autocomplete="new-password">
                    </div>
                    <div style="flex-basis: 100%; display:flex; gap:var(--spacing-sm); align-items:center;">
                        <button type="submit"><i class="fa-solid fa-save"></i> {{ 'Actualizar' if user_to_edit else 'Agregar' }} usuario</button>
                        {% if user_to_edit %}
                        <a href="/admin/clear_user_edit" class="btn" style="background:var(--text-gray);"><i class="fa-solid fa-times"></i> Cancelar edición</a>
                        {% endif %}
                    </div>
                </form>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Email</th>
                                <th>Área</th>
                                <th>Puntos</th>
                                <th>Nivel</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in users %}
                            <tr>
                                <td>{{ u.username }}</td>
                                <td>{{ u.email }}</td>
                                <td>{{ u.area }}</td>
                                <td>{{ u.points }}</td>
                                <td>{{ u.level }}</td>
                                <td>{% if u.is_blocked %}<span style="color:#e74c3c; font-weight:bold;">Bloqueado</span>{% else %}<span style="color:#28a745; font-weight:bold;">Activo</span>{% endif %}</td>
                                <td>
                                    <a href="/admin/edit_user/{{ u.id }}" class="btn" style="padding:0.5rem 1rem;"><i class="fa-solid fa-edit"></i> Editar</a>
                                    <form method="POST" action="/admin/delete_user/{{ u.id }}" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" style="background:#e74c3c; padding:0.5rem 1rem;"><i class="fa-solid fa-trash"></i> Eliminar</button>
                                    </form>
                                    <form method="POST" action="/admin/toggle_block_user/{{ u.id }}" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        {% if u.is_blocked %}
                                        <button type="submit" style="background:#28a745; padding:0.5rem 1rem;"><i class="fa-solid fa-unlock"></i> Desbloquear</button>
                                        {% else %}
                                        <button type="submit" style="background:#ff9800; padding:0.5rem 1rem;"><i class="fa-solid fa-lock"></i> Bloquear</button>
                                        {% endif %}
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="7" class="empty-row">No hay usuarios registrados.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Juegos -->
        <section id="seccion-juegos">
            <div class="section">
                <h2><i class="fa-solid fa-gamepad"></i> Gestión de Juegos</h2>
                <form method="POST" action="/admin/create_game" class="admin-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="game_id" value="{{ game_to_edit.id if game_to_edit else '' }}">
                    <div>
                        <label for="game_name">Nombre del Juego:</label>
                        <input type="text" id="game_name" name="game_name" value="{{ game_to_edit.name if game_to_edit else '' }}" required>
                    </div>
                    <div style="flex:2;">
                        <label for="game_description">Descripción:</label>
                        <input type="text" id="game_description" name="game_description" value="{{ game_to_edit.description if game_to_edit else '' }}" required>
                    </div>
                    <div style="flex:2;">
                        <label for="game_rules">Reglas:</label>
                        <input type="text" id="game_rules" name="game_rules" value="{{ game_to_edit.rules if game_to_edit else '' }}">
                    </div>
                    <div style="flex-basis: 100%; display:flex; gap:var(--spacing-sm);">
                        <button type="submit"><i class="fa-solid fa-save"></i> {{ 'Actualizar' if game_to_edit else 'Agregar' }} Juego</button>
                        {% if game_to_edit %}
                        <a href="/admin/clear_game_edit" class="btn" style="background:var(--text-gray);"><i class="fa-solid fa-times"></i> Cancelar edición</a>
                        {% endif %}
                    </div>
                </form>

                <h3 style="margin-top:var(--spacing-lg);">Juegos Agregados</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Tipo</th>
                                <th>Descripción</th>
                                <th>Reglas</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for game in games %}
                            <tr>
                                <td>{{ game.name }}</td>
                                <td>{{ game.type or 'N/A' }}</td>
                                <td>{{ game.description }}</td>
                                <td>{{ game.rules or 'N/A' }}</td>
                                <td>{{ game.created_at.strftime('%Y-%m-%d') if game.created_at else '' }}</td>
                                <td>
                                    <a href="/admin/edit_game/{{ game.id }}" class="btn" style="padding:0.5rem 1rem;"><i class="fa-solid fa-edit"></i> Editar</a>
                                    <form method="POST" action="/admin/delete_game/{{ game.id }}" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" style="background:#e74c3c; padding:0.5rem 1rem;"><i class="fa-solid fa-trash"></i> Eliminar</button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" class="empty-row">No hay juegos registrados.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Quizzes -->
        <section id="seccion-quizzes">
            <div class="section">
                <h2><i class="fa-solid fa-clipboard-list"></i> Gestión de Quizzes</h2>
                <form method="POST" action="/admin/create_quiz" class="admin-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div>
                        <label for="quiz_name">Nombre del Quiz:</label>
                        <input type="text" id="quiz_name" name="quiz_name" required>
                    </div>
                    <div style="flex:2;">
                        <label for="quiz_area">Área:</label>
                        <input type="text" id="quiz_area" name="quiz_area" required>
                    </div>
                    <div style="flex:2;">
                        <label for="quiz_description">Descripción:</label>
                        <input type="text" id="quiz_description" name="quiz_description" required>
                    </div>
                    <button type="submit"><i class="fa-solid fa-plus"></i> Agregar Quiz</button>
                </form>

                <h3 style="margin-top:var(--spacing-lg);">Quizzes Agregados</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Área</th>
                                <th>Descripción</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for quiz in quizzes %}
                            <tr>
                                <td>{{ quiz.title }}</td>
                                <td>{{ quiz.area }}</td>
                                <td>{{ quiz.description }}</td>
                                <td>{{ quiz.created_at.strftime('%Y-%m-%d') if quiz.created_at else '' }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="empty-row">No hay quizzes registrados.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Preguntas -->
        <section id="seccion-preguntas">
            <div class="section">
                <h2><i class="fa-solid fa-question-circle"></i> Gestión de Preguntas</h2>
                <form method="POST" action="/admin/add_question" class="admin-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div style="flex:2;">
                        <label for="quiz_id">Quiz:</label>
                        <select id="quiz_id" name="quiz_id" required>
                            <option value="">Selecciona un quiz</option>
                            {% for quiz in quizzes %}
                            <option value="{{ quiz.id }}">{{ quiz.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex:3;">
                        <label for="question_text">Pregunta:</label>
                        <input type="text" id="question_text" name="question_text" required>
                    </div>
                    <div style="flex:2;">
                        <label for="option1">Opción 1:</label>
                        <input type="text" id="option1" name="option1" required>
                    </div>
                    <div style="flex:2;">
                        <label for="option2">Opción 2:</label>
                        <input type="text" id="option2" name="option2" required>
                    </div>
                    <div style="flex:2;">
                        <label for="option3">Opción 3:</label>
                        <input type="text" id="option3" name="option3" required>
                    </div>
                    <div style="flex:2;">
                        <label for="option4">Opción 4:</label>
                        <input type="text" id="option4" name="option4" required>
                    </div>
                    <div style="flex:2;">
                        <label for="correct_answer">Respuesta Correcta:</label>
                        <select id="correct_answer" name="correct_answer" required>
                            <option value="">Selecciona la respuesta correcta</option>
                            <option value="1">Opción 1</option>
                            <option value="2">Opción 2</option>
                            <option value="3">Opción 3</option>
                            <option value="4">Opción 4</option>
                        </select>
                    </div>
                    <button type="submit"><i class="fa-solid fa-plus"></i> Agregar Pregunta</button>
                </form>
                <p style="color:var(--text-gray); margin-top:var(--spacing-sm);">Ejemplo de pregunta: ¿Cuál es la salida de <code>print(2+2)</code>? Opciones: 2, 4, 22, Error. Respuesta correcta: 4.</p>
            </div>
        </section>

        <!-- Logros -->
        <section id="seccion-logros">
            <div class="section">
                <h2><i class="fa-solid fa-award"></i> Gestión de Logros/Insignias</h2>
                <form method="POST" action="/admin/create_or_update_achievement" enctype="multipart/form-data" class="admin-form">
                    <input type="hidden" name="achievement_id" value="{{ achievement_to_edit.id if achievement_to_edit else '' }}">
                    <div style="flex:2;">
                        <label for="achievement_name">Nombre:</label>
                        <input type="text" id="achievement_name" name="achievement_name" required value="{{ achievement_to_edit.name if achievement_to_edit else '' }}">
                    </div>
                    <div style="flex:3;">
                        <label for="achievement_description">Descripción:</label>
                        <input type="text" id="achievement_description" name="achievement_description" required value="{{ achievement_to_edit.description if achievement_to_edit else '' }}">
                    </div>
                    <div style="flex:2;">
                        <label for="achievement_image">Imagen:</label>
                        <input type="file" id="achievement_image" name="achievement_image" accept="image/*">
                        {% if achievement_to_edit and achievement_to_edit.image_url %}
                            <img src="{{ achievement_to_edit.image_url }}" alt="Imagen logro" style="max-width:60px; margin-top:0.5rem; border-radius:var(--radius-sm); border:1px solid var(--accent-color);">
                        {% endif %}
                    </div>
                    <div style="flex-basis: 100%; display:flex; gap:var(--spacing-sm);">
                        <button type="submit"><i class="fa-solid fa-save"></i> {{ 'Actualizar' if achievement_to_edit else 'Agregar Logro' }}</button>
                        {% if achievement_to_edit %}
                        <a href="/admin/clear_achievement_edit" class="btn" style="background:var(--text-gray);"><i class="fa-solid fa-times"></i> Cancelar edición</a>
                        {% endif %}
                    </div>
                </form>

                <h3 style="margin-top:var(--spacing-lg);">Logros/Insignias Registrados</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ach in achievements %}
                            <tr>
                                <td>
                                    {% if ach.image_url %}
                                    <img src="{{ ach.image_url }}" alt="img" style="max-width:48px; border-radius:var(--radius-sm); border:1px solid var(--accent-color);">
                                    {% else %}-{% endif %}
                                </td>
                                <td>{{ ach.name }}</td>
                                <td>{{ ach.description }}</td>
                                <td>
                                    <form method="GET" action="/admin/edit_achievement/{{ ach.id }}" style="display:inline;">
                                        <button type="submit" style="padding:0.5rem 1rem;"><i class="fa-solid fa-edit"></i> Editar</button>
                                    </form>
                                    <form method="POST" action="/admin/delete_achievement/{{ ach.id }}" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" style="background:#e74c3c; padding:0.5rem 1rem;"><i class="fa-solid fa-trash"></i> Eliminar</button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="empty-row">No hay logros registrados.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div style="margin-top:var(--spacing-xl);">
                    <h3>Asignar logro/insignia a usuario</h3>
                    <form method="POST" action="/admin/assign_achievement" class="admin-form" style="margin-top:var(--spacing-md);">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div>
                            <label for="user_id">Usuario:</label>
                            <select id="user_id" name="user_id" required>
                                <option value="">Selecciona usuario</option>
                                {% for u in users %}
                                <option value="{{ u.id }}">{{ u.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="badge_id">Logro/Insignia:</label>
                            <select id="badge_id" name="badge_id" required>
                                <option value="">Selecciona logro</option>
                                {% for b in achievements %}
                                <option value="{{ b.id }}">{{ b.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit"><i class="fa-solid fa-plus"></i> Asignar logro</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Reportes -->
        <section id="seccion-reportes">
            <div class="section">
                <h2><i class="fa-solid fa-chart-simple"></i> Panel de Reportes</h2>
                <h3 style="margin-top:var(--spacing-md);">Desbloqueo de Logros/Insignias</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th>Usuarios que lo tienen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ach in achievements %}
                            <tr>
                                <td>
                                    {% if ach.image_url %}
                                    <img src="{{ ach.image_url }}" alt="img" style="max-width:48px; border-radius:var(--radius-sm); border:1px solid var(--accent-color);">
                                    {% else %}-{% endif %}
                                </td>
                                <td>{{ ach.name }}</td>
                                <td>{{ ach.description }}</td>
                                <td><strong>{{ ach.achievements|length }}</strong></td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="empty-row">No hay logros registrados.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Mensajes -->
        <section id="seccion-mensajes">
            <div class="section">
                <h2><i class="fa-solid fa-comments"></i> Mensajes/Notificaciones</h2>
                <form method="POST" action="/admin/send_notification" class="admin-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div style="flex:2;">
                        <label for="notification_message">Mensaje:</label>
                        <input type="text" id="notification_message" name="notification_message" required>
                    </div>
                    <div>
                        <label for="notification_user">Para:</label>
                        <select id="notification_user" name="notification_user">
                            <option value="all">Todos los usuarios</option>
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit"><i class="fa-solid fa-paper-plane"></i> Enviar Notificación</button>
                </form>

                <h3 style="margin-top:var(--spacing-lg);">Historial de Notificaciones</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Mensaje</th>
                                <th>Para</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for n in notifications %}
                            <tr>
                                <td>{{ n.message }}</td>
                                <td>{{ n.to_user if n.to_user else 'Todos' }}</td>
                                <td>{{ n.date_sent.strftime('%Y-%m-%d %H:%M') if n.date_sent else '' }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="empty-row">No hay notificaciones enviadas.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Seguridad -->
        <section id="seccion-seguridad">
            <div class="section">
                <h2><i class="fa-solid fa-shield-halved"></i> Seguridad</h2>
                <form method="POST" action="/admin/change_password" style="max-width:500px; margin-bottom:var(--spacing-xl);">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <h3 style="font-size:1.2rem; margin-bottom:var(--spacing-md);">Cambiar contraseña de administrador</h3>
                    <div style="margin-bottom:var(--spacing-sm);">
                        <label for="current_password" style="font-weight:600; color:var(--primary-color); display:block; margin-bottom:0.3rem;">Contraseña actual:</label>
                        <input type="password" id="current_password" name="current_password" required autocomplete="current-password" style="width:100%; padding:0.6rem; border-radius:var(--radius-sm); border:2px solid var(--accent-color);">
                    </div>
                    <div style="margin-bottom:var(--spacing-sm);">
                        <label for="new_password" style="font-weight:600; color:var(--primary-color); display:block; margin-bottom:0.3rem;">Nueva contraseña:</label>
                        <input type="password" id="new_password" name="new_password" required autocomplete="new-password" style="width:100%; padding:0.6rem; border-radius:var(--radius-sm); border:2px solid var(--accent-color);">
                    </div>
                    <div style="margin-bottom:var(--spacing-md);">
                        <label for="confirm_password" style="font-weight:600; color:var(--primary-color); display:block; margin-bottom:0.3rem;">Confirmar nueva contraseña:</label>
                        <input type="password" id="confirm_password" name="confirm_password" required autocomplete="new-password" style="width:100%; padding:0.6rem; border-radius:var(--radius-sm); border:2px solid var(--accent-color);">
                    </div>
                    <button type="submit"><i class="fa-solid fa-key"></i> Actualizar contraseña</button>
                </form>

                <h3 style="font-size:1.2rem; margin-bottom:var(--spacing-md);">Logs de acceso recientes</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>IP</th>
                                <th>Fecha y hora</th>
                                <th>Éxito</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in access_logs %}
                            <tr>
                                <td>{{ log.username }}</td>
                                <td>{{ log.ip }}</td>
                                <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>{{ 'Sí' if log.success else 'No' }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="empty-row">No hay logs recientes.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <!-- Datos desde Flask para JS -->
    <script id="flask-data" type="application/json">
    {
        "totalUsers": {{ total_users|default(0)|tojson|safe }},
        "totalQuizzes": {{ total_quizzes|default(0)|tojson|safe }},
        "totalQuestions": {{ total_questions|default(0)|tojson|safe }}
    }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Datos de Flask
        const flaskData = JSON.parse(document.getElementById('flask-data').textContent);
        const totalUsers = flaskData.totalUsers;
        const totalQuizzes = flaskData.totalQuizzes;
        const totalQuestions = flaskData.totalQuestions;

        // Gráfica de barras
        const ctxBar = document.getElementById('statsBarChart').getContext('2d');
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: ['Usuarios', 'Quizzes', 'Preguntas'],
                datasets: [{
                    label: 'Cantidad',
                    data: [totalUsers, totalQuizzes, totalQuestions],
                    backgroundColor: [
                        '#6A2C3D',
                        '#B57386',
                        '#8A4255'
                    ],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Totales del sistema', color: '#6A2C3D', font: { size: 18, weight: 'bold' } }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { color: '#6A2C3D', font: { weight: 'bold' } } },
                    x: { ticks: { color: '#6A2C3D', font: { weight: 'bold' } } }
                }
            }
        });

        // Gráfica de pastel
        const ctxPie = document.getElementById('statsPieChart').getContext('2d');
        new Chart(ctxPie, {
            type: 'pie',
            data: {
                labels: ['Usuarios', 'Quizzes', 'Preguntas'],
                datasets: [{
                    data: [totalUsers, totalQuizzes, totalQuestions],
                    backgroundColor: [
                        '#6A2C3D',
                        '#B57386',
                        '#8A4255'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#6A2C3D', font: { weight: 'bold' } } },
                    title: { display: true, text: 'Distribución', color: '#6A2C3D', font: { size: 18, weight: 'bold' } }
                }
            }
        });

        // Modal de confirmación de logout
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutModal = document.getElementById('logoutModal');
        const confirmLogout = document.getElementById('confirmLogout');
        const cancelLogout = document.getElementById('cancelLogout');

        if (logoutBtn && logoutModal && confirmLogout && cancelLogout) {
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                logoutModal.style.display = 'flex';
            });

            cancelLogout.addEventListener('click', function() {
                logoutModal.style.display = 'none';
            });

            confirmLogout.addEventListener('click', function() {
                document.getElementById('logoutForm').submit();
            });
        }

        // Mobile menu toggle
        document.addEventListener('DOMContentLoaded', function() {
            const navToggle = document.getElementById('navToggle');
            const navWrapper = document.getElementById('navWrapper');
            const navOverlay = document.getElementById('navOverlay');
            const menuIconOpen = document.getElementById('menuIconOpen');
            const menuIconClose = document.getElementById('menuIconClose');

            if (navToggle && navWrapper && navOverlay) {
                navToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    navWrapper.classList.toggle('active');
                    navOverlay.classList.toggle('active');
                    
                    // Toggle icons
                    if (navWrapper.classList.contains('active')) {
                        menuIconOpen.style.display = 'none';
                        menuIconClose.style.display = 'block';
                        document.body.style.overflow = 'hidden';
                    } else {
                        menuIconOpen.style.display = 'block';
                        menuIconClose.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });

                // Close menu when clicking overlay
                navOverlay.addEventListener('click', function() {
                    navWrapper.classList.remove('active');
                    navOverlay.classList.remove('active');
                    menuIconOpen.style.display = 'block';
                    menuIconClose.style.display = 'none';
                    document.body.style.overflow = '';
                });

                // Close menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!navToggle.contains(event.target) && !navWrapper.contains(event.target)) {
                        navWrapper.classList.remove('active');
                        navOverlay.classList.remove('active');
                        menuIconOpen.style.display = 'block';
                        menuIconClose.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });
            }
        });

        // Smooth scroll
        document.querySelectorAll('.nav-links a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const targetId = this.getAttribute('href').substring(1);
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    const navHeight = document.querySelector('.navbar').offsetHeight;
                    const targetPosition = targetElement.offsetTop - navHeight - 20;
                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });
                    // Close mobile menu if open
                    const navWrapper = document.getElementById('navWrapper');
                    const navOverlay = document.getElementById('navOverlay');
                    const menuIconOpen = document.getElementById('menuIconOpen');
                    const menuIconClose = document.getElementById('menuIconClose');
                    if (navWrapper && navWrapper.classList.contains('active')) {
                        navWrapper.classList.remove('active');
                        navOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                        if (menuIconOpen && menuIconClose) {
                            menuIconOpen.style.display = 'block';
                            menuIconClose.style.display = 'none';
                        }
                    }
                }
            });
        });

        // Confirmaciones para acciones de usuarios
        document.addEventListener('DOMContentLoaded', function() {
            // Confirmación para eliminar usuarios
            const deleteUserForms = document.querySelectorAll('form[action*="/admin/delete_user/"]');
            deleteUserForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const userName = this.closest('tr').querySelector('td:first-child').textContent.trim();
                    if (confirm(`¿Estás seguro de que quieres eliminar el usuario "${userName}"? Esta acción no se puede deshacer.`)) {
                        this.submit();
                    }
                });
            });

            // Confirmación para bloquear/desbloquear usuarios
            const blockUserForms = document.querySelectorAll('form[action*="/admin/toggle_block_user/"]');
            blockUserForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const userName = this.closest('tr').querySelector('td:first-child').textContent.trim();
                    const button = this.querySelector('button[type="submit"]');
                    const action = button.textContent.trim().toLowerCase();

                    if (confirm(`¿Estás seguro de que quieres ${action} el usuario "${userName}"?`)) {
                        this.submit();
                    }
                });
            });

            // Confirmación para eliminar juegos
            const deleteGameForms = document.querySelectorAll('form[action*="/admin/delete_game/"]');
            deleteGameForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const gameName = this.closest('tr').querySelector('td:first-child').textContent.trim();
                    if (confirm(`¿Estás seguro de que quieres eliminar el juego "${gameName}"? Esta acción no se puede deshacer.`)) {
                        this.submit();
                    }
                });
            });
        });

        // Prevenir volver atrás después de logout
        window.addEventListener('pageshow', function(event) {
            if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                window.location.href = '/login';
            }
        });

        // Table scroll indicators
        document.addEventListener('DOMContentLoaded', function() {
            const tableWrappers = document.querySelectorAll('.table-wrapper');
            
            tableWrappers.forEach(wrapper => {
                const table = wrapper.querySelector('table');
                if (table && wrapper.scrollWidth > wrapper.clientWidth) {
                    wrapper.classList.add('has-scroll');
                    
                    // Add scroll event listener
                    wrapper.addEventListener('scroll', function() {
                        const scrollLeft = wrapper.scrollLeft;
                        const maxScroll = wrapper.scrollWidth - wrapper.clientWidth;
                        
                        if (scrollLeft >= maxScroll - 10) {
                            wrapper.classList.add('scrolled-end');
                        } else {
                            wrapper.classList.remove('scrolled-end');
                        }
                        
                        if (scrollLeft > 10) {
                            wrapper.classList.add('scrolled-start');
                        } else {
                            wrapper.classList.remove('scrolled-start');
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>