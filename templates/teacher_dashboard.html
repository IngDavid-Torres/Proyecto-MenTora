<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Panel Profesor | MenTora</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Exo+2:wght@600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/teacher_dashboard.css">
</head>
<body>
    <nav class="navbar">
        <a href="/" class="logo">
            <img src="/static/img/mentora1.png" alt="MenTora Logo">
        </a>
        <button id="navToggle" class="menu-button" aria-label="Abrir menú">
            <img src="https://api.iconify.design/mdi/menu.svg?color=%23ffffff" alt="menu" class="menu-icon">
        </button>
        <ul class="nav-links" id="navLinks">
            <li><a href="#estadisticas" onclick="scrollToSection('estadisticas')">ESTADÍSTICAS</a></li>
            <li><a href="#mis-quizzes" onclick="scrollToSection('mis-quizzes')">MIS QUIZZES</a></li>
            <li><a href="#generador-ia" onclick="scrollToSection('generador-ia')">GENERADOR IA</a></li>
            <li><a href="#mis-juegos" onclick="scrollToSection('mis-juegos')">MIS JUEGOS</a></li>
            <li><a href="#preguntas" onclick="scrollToSection('preguntas')">PREGUNTAS</a></li>
            <li><a href="#" id="logoutBtn" style="font-weight:700;">CERRAR SESIÓN</a></li>
        </ul>
    </nav>
    <div id="logoutModal" class="modal">
        <div style="background:#fff; color:var(--primary-color); border-radius:18px; padding:2.2rem 2.5rem; box-shadow:0 4px 32px rgba(106, 44, 61, 0.3); display:flex; flex-direction:column; align-items:center; min-width:320px; max-width:90vw; border:3px solid var(--accent-color);">
            <div style="font-size:2.1rem; font-weight:bold; margin-bottom:1.1rem;">¿Seguro que quieres cerrar sesión?</div>
            <div style="margin-bottom:1.2rem; color:var(--text-gray); font-size:1.1rem;">Tu sesión se cerrará y deberás volver a iniciar sesión para acceder de nuevo.</div>
            <div style="display:flex; gap:1.2rem; flex-wrap:wrap; justify-content:center;">
                <button id="confirmLogout" class="btn" style="background:var(--primary-color);">Sí, cerrar sesión</button>
                <button id="cancelLogout" class="btn" style="background:var(--text-gray);">Cancelar</button>
            </div>
        </div>
    </div>
    <div class="container">
        <h1><i class="fa-solid fa-chalkboard-user"></i> BIENVENIDO, {{ user.username|upper }} <span style="font-size:1.1rem; color:var(--accent-color);">(PROFESOR)</span></h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {# Solo mostrar mensajes de teacher - ignorar mensajes de otros contextos #}
                    {% if category == 'teacher' %}
                        <div class="alert alert-{{ category }}" style="background: linear-gradient(90deg, var(--accent-color), var(--light-blue)); color: var(--primary-color); padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; font-weight: 600; text-align: center; box-shadow: var(--shadow-md);">
                            {{ message }}
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div id="cedula" class="section" style="margin-bottom:var(--spacing-xl);">
            <h2><i class="fa-solid fa-id-card"></i> Verificación de Cédula Profesional</h2>
            {% if teacher.cedula_profesional_img %}
                <div style="background:rgba(255,255,255,0.3); border-radius:12px; padding:var(--spacing-md); margin-bottom:var(--spacing-md); border:2px solid var(--accent-color);">
                    <div style="display:flex; align-items:center; gap:var(--spacing-md); flex-wrap:wrap;">
                        <div style="flex:1; min-width:250px;">
                            <h3 style="margin-bottom:var(--spacing-sm);">
                                <i class="fa-solid fa-image"></i> Cédula Profesional Subida
                            </h3>
                            <p style="color:var(--text-gray); margin-bottom:var(--spacing-sm);">
                                {% if teacher.cedula_verified %}
                                    <span style="color:#28a745; font-weight:600;">
                                        <i class="fa-solid fa-check-circle"></i> Verificada
                                    </span>
                                {% else %}
                                    <span style="color:#ffc107; font-weight:600;">
                                        <i class="fa-solid fa-clock"></i> Pendiente de verificación
                                    </span>
                                {% endif %}
                            </p>
                            <p style="color:var(--text-gray); font-size:0.9rem; margin-bottom:var(--spacing-sm);">
                                La cédula profesional es necesaria para validar tu identidad como docente.
                            </p>
                            <button onclick="document.getElementById('uploadCedulaModal').style.display='flex'" class="btn" style="margin-top:var(--spacing-sm);">
                                <i class="fa-solid fa-upload"></i> Actualizar Cédula
                            </button>
                        </div>
                        <div style="flex:1; min-width:250px; max-width:400px;">
                            <img src="/{{ teacher.cedula_profesional_img }}" alt="Cédula Profesional" style="width:100%; height:auto; border-radius:var(--radius-md); box-shadow:var(--shadow-md); cursor:pointer;" onclick="openImageModal('/{{ teacher.cedula_profesional_img }}')">
                        </div>
                    </div>
                </div>
            {% else %}
                <div style="background:rgba(255,220,100,0.15); border-radius:12px; padding:var(--spacing-lg); text-align:center; border:2px dashed var(--accent-color);">
                    <i class="fa-solid fa-exclamation-triangle" style="font-size:3rem; color:var(--accent-color); margin-bottom:var(--spacing-sm);"></i>
                    <h3 style="margin-bottom:var(--spacing-sm); color:var(--primary-color);">
                        Cédula Profesional Requerida
                    </h3>
                    <p style="color:var(--text-gray); margin-bottom:var(--spacing-md); max-width:600px; margin-left:auto; margin-right:auto;">
                        Para verificar tu identidad como docente, necesitas subir una imagen de tu cédula profesional.
                        Esta información es confidencial y solo será utilizada para verificación.
                    </p>
                    <button onclick="document.getElementById('uploadCedulaModal').style.display='flex'" class="btn">
                        <i class="fa-solid fa-upload"></i> Subir Cédula Profesional
                    </button>
                </div>
            {% endif %}
        </div>

        <div id="estadisticas" class="dashboard-cards">
            <div class="dashboard-card">
                <i class="fa-solid fa-graduation-cap"></i>
                <div class="count" id="quizCount">{{ quizzes|length }}</div>
                <div class="label">Quizzes creados</div>
                <div class="area"><i class="fa-solid fa-layer-group"></i> {{ teacher.area or 'General' }}</div>
            </div>
            <div class="dashboard-card">
                <i class="fa-solid fa-gamepad"></i>
                <div class="count" id="gameCount">{{ games|length }}</div>
                <div class="label">Juegos creados</div>
            </div>
        </div>
        <div class="section">
            <h2><i class="fa-solid fa-users"></i> Alumnos inscritos en tu área</h2>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>Nombre</th><th>Correo</th><th>Puntaje en tus quizzes</th></tr></thead>
                    <tbody>
                    {% for s in student_scores %}
                    {% if s.student.id != user.id %}
                    <tr>
                        <td>{{ s.student.username }}</td>
                        <td>{{ s.student.email }}</td>
                        <td>{{ s.quiz_points }}</td>
                    </tr>
                    {% endif %}
                    {% else %}
                    <tr><td colspan="3" class="empty-row">No hay alumnos inscritos en tu área.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div id="mis-quizzes" class="section">
            <h2><i class="fa-solid fa-list-check"></i> Mis Quizzes/Exámenes</h2>
            <a href="#" class="btn" id="openQuizModal"><i class="fa-solid fa-plus"></i> Crear nuevo quiz/examen</a>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>Título</th><th>Área</th><th>Fecha</th><th>Acciones</th></tr></thead>
                    <tbody>
                    {% for quiz in quizzes %}
                    <tr>
                        <td>{{ quiz.title }}</td>
                        <td>{{ quiz.area }}</td>
                        <td>{{ quiz.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <a href="{{ url_for('editar_quiz', quiz_id=quiz.id) }}" class="btn"><i class="fa-solid fa-pen"></i> Editar</a>
                            <form method="POST" action="{{ url_for('eliminar_quiz', quiz_id=quiz.id) }}" style="display:inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn" style="background:#e74c3c; color:#fff;"><i class="fa-solid fa-trash"></i> Eliminar</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" class="empty-row">No has creado quizzes aún.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div id="generador-ia" class="section">
            <h2><i class="fa-solid fa-robot"></i> Generador de Exámenes con IA Local</h2>
            <div style="background:rgba(255,255,255,0.2); border-radius:12px; box-shadow:var(--shadow-sm); padding:1.5rem 1.2rem; margin-bottom:1rem; border:1px solid var(--accent-color);">
                <div style="color:var(--primary-color); margin-bottom:1rem; display:flex; align-items:center; gap:0.5rem;">
                    <i class="fa-solid fa-microchip" style="color:var(--accent-color);"></i>
                    <strong>IA Local - Sin necesidad de internet</strong>
                </div>
                <form method="POST" action="" class="ai-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <label><i class="fa-solid fa-lightbulb"></i> Tema:</label>
                    <input type="text" name="tema" required placeholder="Ej: Álgebra, Historia, Ciencias...">
                    
                    <label><i class="fa-solid fa-list-ol"></i> Cantidad de preguntas:</label>
                    <input type="number" name="cantidad" min="1" max="20" value="5" required>
                    
                    <label><i class="fa-solid fa-list"></i> Tipo de examen:</label>
                    <select name="tipo_examen" style="padding:0.5rem; border-radius:7px; border:1px solid #b2f0e6; font-size:1rem;">
                        <option value="simple" {% if ia_tipo_examen == 'simple' %}selected{% endif %}>Solo preguntas</option>
                        <option value="opciones" {% if ia_tipo_examen == 'opciones' %}selected{% endif %}>Preguntas con opciones múltiples</option>
                    </select>
                    
                    <label><i class="fa-solid fa-cogs"></i> Método de IA:</label>
                    <select name="ai_method" style="padding:0.5rem; border-radius:7px; border:1px solid #b2f0e6; font-size:1rem;">
                        <option value="offline"><i class="fa-solid fa-rocket"></i> Plantillas (Rápido)</option>
                        <option value="ollama"><i class="fa-solid fa-brain"></i> Ollama (Requiere instalación)</option>
                        <option value="huggingface"><i class="fa-solid fa-face-smile"></i> Hugging Face (Requiere descarga)</option>
                    </select>
                    
                    <button type="submit" class="btn"><i class="fa-solid fa-microchip"></i> Generar con IA Local</button>
                </form>
                
                <div style="margin-top:1rem; padding:0.8rem; background:rgba(181, 115, 134, 0.1); border-radius:8px; border-left:4px solid var(--accent-color);">
                    <strong style="color:var(--primary-color);"><i class="fa-solid fa-lightbulb"></i> Métodos disponibles:</strong>
                    <ul style="margin:0.5rem 0 0 1rem; color:var(--text-gray);">
                        <li><strong>Plantillas:</strong> Rápido, funciona siempre, ideal para demostración</li>
                        <li><strong>Ollama:</strong> IA avanzada local (requiere instalar Ollama + modelo)</li>
                        <li><strong>Hugging Face:</strong> Modelos preentrenados (descarga automática)</li>
                    </ul>
                </div>
            </div>
            {% if ia_questions %}
            <div style="margin-top:1.5rem; background:rgba(255,255,255,0.3); border-radius:12px; box-shadow:var(--shadow-md); padding:1.5rem 1.2rem; border:1px solid var(--accent-color);">
                <h3>
                    <i class="fa-solid fa-microchip"></i> Examen generado con IA Local
                    <span style="color:var(--accent-color);">{{ teacher.area or 'General' }}</span>
                    <span style="font-size:0.9rem; color:var(--text-gray); margin-left:1rem;">
                        <i class="fa-solid fa-wifi-slash"></i> Sin conexión a internet
                    </span>
                </h3>
                {% if ia_tipo_examen == 'opciones' and ia_questions and ia_questions[0] is mapping %}
                    <ol style="font-size:1.08rem; color:var(--text-gray);">
                    {% for q in ia_questions %}
                        <li>
                            <strong>{{ q.pregunta }}</strong>
                            <ul style="margin-top:0.3rem;">
                                {% for opt in q.opciones %}
                                <li style="list-style-type: lower-alpha;">{{ opt }}</li>
                                {% endfor %}
                            </ul>
                            <span style="color:var(--primary-color); font-size:0.98rem;"><b>Respuesta correcta:</b> {{ q.respuesta }}</span>
                        </li>
                    {% endfor %}
                    </ol>
                {% else %}
                    <ol style="font-size:1.08rem; color:var(--text-gray);">
                    {% for q in ia_questions %}
                        <li>{{ q }}</li>
                    {% endfor %}
                    </ol>
                {% endif %}
                <div style="margin-top:1.2rem; display:flex; gap:1rem; flex-wrap:wrap;">
                    <form method="post" action="{{ url_for('download_exam_simple') }}" style="display:inline;">
                        <input type="hidden" name="tema" value="{{ ia_tema }}">
                        <input type="hidden" name="area" value="{{ teacher.area }}">
                        <input type="hidden" name="tipo_examen" value="{{ ia_tipo_examen }}">
                        <input type="hidden" name="preguntas" value="{{ ia_questions|safe_json }}">
                        <button type="submit" class="btn" style="background:var(--secondary-color);">
                            <i class="fa-solid fa-file-lines"></i> Descargar TXT
                        </button>
                    </form>
                    <form method="post" action="{{ url_for('download_exam_word') }}" style="display:inline;">
                        <input type="hidden" name="tema" value="{{ ia_tema }}">
                        <input type="hidden" name="area" value="{{ teacher.area }}">
                        <input type="hidden" name="tipo_examen" value="{{ ia_tipo_examen }}">
                        <input type="hidden" name="preguntas" value="{{ ia_questions|safe_json }}">
                        <button type="submit" class="btn"><i class="fa-solid fa-file-word"></i> Descargar Word</button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
        <div id="mis-juegos" class="section">
            <h2><i class="fa-solid fa-puzzle-piece"></i> Mis Juegos/Retos</h2>
            <a href="#" class="btn" id="openGameModal"><i class="fa-solid fa-plus"></i> Crear nuevo juego/reto</a>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>Nombre</th><th>Tipo</th><th>Fecha</th><th>Acciones</th></tr></thead>
                    <tbody>
                    {% for game in games %}
                    <tr>
                        <td>{{ game.name }}</td>
                        <td>{{ game.type }}</td>
                        <td>{{ game.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <a href="{{ url_for('editar_juego', game_id=game.id) }}" class="btn"><i class="fa-solid fa-pen"></i> Editar</a>
                            <form method="POST" action="{{ url_for('eliminar_juego', game_id=game.id) }}" style="display:inline;">
                                <button type="submit" class="btn" style="background:#e74c3c; color:#fff;"><i class="fa-solid fa-trash"></i> Eliminar</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" class="empty-row">No has creado juegos aún.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h2><i class="fa-solid fa-bell"></i> Notificaciones recientes</h2>
            <ul class="notifications">
            {% for n in notifications %}
                <li><i class="fa-solid fa-bell"></i> {{ n.message }} <span style="color:#888;">({{ n.date_sent.strftime('%Y-%m-%d') }})</span></li>
            {% else %}
                <li class="empty-row"><i class="fa-solid fa-bell-slash"></i> No tienes notificaciones recientes.</li>
            {% endfor %}
            </ul>
        </div>
        <!-- Modales -->
        <!-- Modal para subir cédula profesional -->
        <div id="uploadCedulaModal" class="modal">
            <form method="POST" action="{{ url_for('upload_cedula') }}" enctype="multipart/form-data" style="background:rgba(255,255,255,0.98); border-radius:18px; padding:2rem 2.5rem; box-shadow:0 4px 32px rgba(106, 44, 61, 0.3); display:flex; flex-direction:column; gap:1rem; min-width:320px; max-width:500px; width:90%; border:3px solid var(--accent-color);">
                <h3 style="color:var(--primary-color); text-align:center; margin-bottom:var(--spacing-sm);">
                    <i class="fa-solid fa-id-card"></i> Subir Cédula Profesional
                </h3>
                <p style="color:var(--text-gray); font-size:0.95rem; text-align:center; margin-bottom:var(--spacing-md);">
                    Selecciona una imagen de tu cédula profesional para verificar tu identidad como docente.
                </p>
                <div style="border:2px dashed var(--accent-color); border-radius:var(--radius-md); padding:var(--spacing-lg); text-align:center; background:rgba(181, 115, 134, 0.05);">
                    <i class="fa-solid fa-cloud-upload-alt" style="font-size:3rem; color:var(--accent-color); margin-bottom:var(--spacing-sm);"></i>
                    <input type="file" name="cedula_file" id="cedula_file" accept="image/*" required style="display:none;" onchange="updateFileName(this)">
                    <label for="cedula_file" style="display:block; cursor:pointer; color:var(--primary-color); font-weight:600; margin-bottom:var(--spacing-xs);">
                        Haz clic para seleccionar una imagen
                    </label>
                    <p id="file-name" style="color:var(--text-gray); font-size:0.9rem; margin-top:var(--spacing-xs);">
                        Formatos: PNG, JPG, JPEG, GIF, WEBP
                    </p>
                </div>
                <div style="display:flex; gap:var(--spacing-sm); justify-content:center; margin-top:var(--spacing-sm);">
                    <button type="submit" class="btn">
                        <i class="fa-solid fa-upload"></i> Subir
                    </button>
                    <button type="button" class="btn" style="background:var(--text-gray);" onclick="document.getElementById('uploadCedulaModal').style.display='none'">
                        <i class="fa-solid fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>

        <div id="modalQuiz" class="modal">
            <form method="POST" action="{{ url_for('teacher_create_quiz') }}">
                <h3>{{ 'Editar Quiz/Examen' if quiz_to_edit else 'Crear nuevo Quiz/Examen' }}</h3>
                <input type="hidden" name="quiz_id" value="{{ quiz_to_edit.id if quiz_to_edit else '' }}">
                <input type="text" name="title" placeholder="Título" required value="{{ quiz_to_edit.title if quiz_to_edit else '' }}">
                <input type="text" name="area" placeholder="Área" value="{{ quiz_to_edit.area if quiz_to_edit else teacher.area or '' }}" required>
                <button type="submit" class="btn">{{ 'Actualizar' if quiz_to_edit else 'Guardar' }}</button>
                <button type="button" class="btn" style="background:var(--text-gray);" onclick="document.getElementById('modalQuiz').style.display='none'">Cancelar</button>
                {% if quiz_to_edit %}
                <a href="{{ url_for('teacher_dashboard') }}" class="btn" style="background:var(--text-gray);">Cancelar edición</a>
                {% endif %}
            </form>
        </div>
        <div id="modalGame" class="modal">
            <form method="POST" action="{{ url_for('teacher_create_game') }}">
                <h3>{{ 'Editar Juego/Reto' if game_to_edit else 'Crear nuevo Juego/Reto' }}</h3>
                <input type="hidden" name="game_id" value="{{ game_to_edit.id if game_to_edit else '' }}">
                <input type="text" name="name" placeholder="Nombre del juego" required value="{{ game_to_edit.name if game_to_edit else '' }}">
                <input type="text" name="type" placeholder="Tipo de juego" required value="{{ game_to_edit.type if game_to_edit else '' }}">
                <button type="submit" class="btn">{{ 'Actualizar' if game_to_edit else 'Guardar' }}</button>
                <button type="button" class="btn" style="background:var(--text-gray);" onclick="document.getElementById('modalGame').style.display='none'">Cancelar</button>
                {% if game_to_edit %}
                <a href="{{ url_for('teacher_dashboard') }}" class="btn" style="background:var(--text-gray);">Cancelar edición</a>
                {% endif %}
            </form>
        </div>
        <div id="preguntas" class="section">
            <h2><i class="fa-solid fa-question"></i> Agregar preguntas a un Quiz</h2>
            <form method="POST" action="{{ url_for('teacher_add_question') }}" class="ai-form" style="background:rgba(255,255,255,0.2); border-radius:12px; padding:1.5rem 1.2rem; margin-bottom:1.5rem;">
                <label for="quiz_id"><i class="fa-solid fa-clipboard-question"></i> Quiz:</label>
                <select name="quiz_id" required>
                    {% for quiz in quizzes %}
                    <option value="{{ quiz.id }}">{{ quiz.title }} ({{ quiz.area }})</option>
                    {% endfor %}
                </select>
                <label for="question_text"><i class="fa-solid fa-circle-question"></i> Pregunta:</label>
                <input type="text" name="question_text" required placeholder="Escribe la pregunta">
                <label><i class="fa-solid fa-list"></i> Opciones:</label>
                <input type="text" name="option1" required placeholder="Opción 1">
                <input type="text" name="option2" required placeholder="Opción 2">
                <input type="text" name="option3" required placeholder="Opción 3">
                <input type="text" name="option4" required placeholder="Opción 4">
                <label for="correct_answer"><i class="fa-solid fa-check-circle"></i> Respuesta correcta:</label>
                <select name="correct_answer" required>
                    <option value="1">Opción 1</option>
                    <option value="2">Opción 2</option>
                    <option value="3">Opción 3</option>
                    <option value="4">Opción 4</option>
                </select>
                <button type="submit" class="btn"><i class="fa-solid fa-plus"></i> Agregar pregunta</button>
            </form>
        </div>
        <div class="section">
            <h2><i class="fa-solid fa-list-ul"></i> Preguntas agregadas a los Quizzes</h2>
            {% for quiz in quizzes %}
            <div style="margin-bottom:1.5rem; background:rgba(255,255,255,0.3); border-radius:12px; box-shadow:var(--shadow-sm); padding:1.2rem 1rem; border:1px solid var(--accent-color);">
                <h3><i class="fa-solid fa-file-lines"></i> {{ quiz.title }} ({{ quiz.area }})</h3>
                {% if quiz.questions %}
                <table style="width:100%;">
                    <thead><tr><th>Pregunta</th><th>Opciones</th><th>Respuesta correcta</th><th>Acciones</th></tr></thead>
                    <tbody>
                    {% for q in quiz.questions %}
                    <tr>
                        <td>{{ q.text }}</td>
                        <td>
                            <ul style="padding-left:1.2rem; margin:0;">
                            {% for opt in q.options %}
                                <li>{{ opt }}</li>
                            {% endfor %}
                            </ul>
                        </td>
                        <td><b>{{ q.correct_answer }}</b></td>
                        <td>
                                <form method="POST" action="{{ url_for('eliminar_pregunta', question_id=q.id) }}" style="display:inline;">
                                    <button type="submit" class="btn" style="background:#e74c3c; color:#fff; font-size:0.95rem;"><i class="fa-solid fa-trash"></i> Eliminar</button>
                                </form>
                                <a href="{{ url_for('edit_question', question_id=q.id) }}" class="btn" style="font-size:0.95rem;"><i class="fa-solid fa-pen"></i> Editar</a>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-row">No hay preguntas agregadas a este quiz.</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    <!-- Footer -->
    <footer class="footer">
    &copy; 2025 MenTora | Aprende jugando. Todos los derechos reservados.
    <!-- Socket.IO client for live chat -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
    // Smooth scroll function
    function scrollToSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
            const navHeight = document.querySelector('.navbar').offsetHeight;
            const targetPosition = section.offsetTop - navHeight - 20;
            window.scrollTo({
                top: targetPosition,
                behavior: 'smooth'
            });
            // Close mobile menu if open
            const navLinks = document.getElementById('navLinks');
            if (navLinks && navLinks.classList.contains('active')) {
                navLinks.classList.remove('active');
            }
        }
        return false;
    }

    // Mobile menu toggle
    document.addEventListener('DOMContentLoaded', function() {
        const navToggle = document.getElementById('navToggle');
        const navLinks = document.getElementById('navLinks');

        if (navToggle && navLinks) {
            navToggle.addEventListener('click', function() {
                navLinks.classList.toggle('active');
            });
        }
    });

    // Auto-hide flash messages after 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            setTimeout(function() {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(function() {
                    alert.remove();
                }, 500);
            }, 5000);
        });
    });

    // Modal de confirmación de logout
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutModal = document.getElementById('logoutModal');
    const confirmLogout = document.getElementById('confirmLogout');
    const cancelLogout = document.getElementById('cancelLogout');
    if (logoutBtn && logoutModal && confirmLogout && cancelLogout) {
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            logoutModal.style.display = 'flex';
        });
        cancelLogout.addEventListener('click', function() {
            logoutModal.style.display = 'none';
        });
        confirmLogout.addEventListener('click', async function() {
            // Cierre de sesión real por POST y redirección segura
            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
                await fetch('/logout', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'csrf_token=' + encodeURIComponent(csrfToken)
                });
            } catch (e) {}
            // Limpiar historial y redirigir
            window.location.replace('/login');
        });
    }
    // Evitar volver atrás tras logout
    window.addEventListener('pageshow', function(event) {
        if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
            window.location.replace('/login');
        }
    });
    </script>
    </footer>
    <script>
    // Función global para abrir modales - más confiable
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'flex';
        }
    }
    
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // Abrir modales de creación de quiz/juego
    document.addEventListener('DOMContentLoaded', function() {
        // Implementación más robusta usando múltiples métodos
        const openQuizBtn = document.getElementById('openQuizModal');
        const openGameBtn = document.getElementById('openGameModal');
        const modalQuiz = document.getElementById('modalQuiz');
        const modalGame = document.getElementById('modalGame');
        
        // Modal de Quiz - Método robusto
        if (openQuizBtn) {
            // Remover cualquier event listener previo
            openQuizBtn.removeEventListener('click', handleQuizClick);
            openQuizBtn.addEventListener('click', handleQuizClick);
            
            function handleQuizClick(e) {
                e.preventDefault();
                e.stopPropagation();
                openModal('modalQuiz');
            }
        }
        
        // Modal de Juego - Método robusto
        if (openGameBtn) {
            // Remover cualquier event listener previo
            openGameBtn.removeEventListener('click', handleGameClick);
            openGameBtn.addEventListener('click', handleGameClick);
            
            function handleGameClick(e) {
                e.preventDefault();
                e.stopPropagation();
                openModal('modalGame');
            }
        }
        
        // Cerrar modales al hacer clic fuera
        [modalQuiz, modalGame].forEach(modal => {
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            }
        });
        
        // Cerrar modales con Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal('modalQuiz');
                closeModal('modalGame');
            }
        });
        
        // Botones de cancelar - método más directo
        const cancelButtons = document.querySelectorAll('button[onclick*="modalQuiz"], button[onclick*="modalGame"]');
        cancelButtons.forEach(btn => {
            const originalOnclick = btn.getAttribute('onclick');
            if (originalOnclick) {
                btn.removeAttribute('onclick');
                btn.addEventListener('click', function() {
                    if (originalOnclick.includes('modalQuiz')) {
                        closeModal('modalQuiz');
                    }
                    if (originalOnclick.includes('modalGame')) {
                        closeModal('modalGame');
                    }
                });
            }
        });
    });
    
    // Funciones globales de respaldo
    window.openModal = openModal;
    window.closeModal = closeModal;
    
    // Animación de contadores
    function animateCount(id, end) {
        const el = document.getElementById(id);
        if (!el) return;
        let start = 0;
        const duration = 900;
        const step = Math.ceil(end / (duration / 30));
        function update() {
            start += step;
            if (start >= end) {
                el.textContent = end;
            } else {
                el.textContent = start;
                setTimeout(update, 30);
            }
        }
        update();
    }
    animateCount('quizCount', parseInt(document.getElementById('quizCount').textContent));
    animateCount('gameCount', parseInt(document.getElementById('gameCount').textContent));

    // Función para actualizar el nombre del archivo seleccionado
    function updateFileName(input) {
        const fileName = input.files[0] ? input.files[0].name : 'No se ha seleccionado ningún archivo';
        document.getElementById('file-name').textContent = fileName;
    }

    // Función para abrir modal de imagen
    function openImageModal(imageSrc) {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;cursor:zoom-out;';
        modal.onclick = function() { document.body.removeChild(modal); };

        const img = document.createElement('img');
        img.src = imageSrc;
        img.style.cssText = 'max-width:90%;max-height:90%;border-radius:var(--radius-md);box-shadow:0 0 50px rgba(255,255,255,0.3);';

        modal.appendChild(img);
        document.body.appendChild(modal);
    }
    </script>
    <!-- Botones flotantes -->
    <button class="livechat-toggle" id="livechat-toggle" title="Chat en vivo" onclick="toggleLiveChat()"><i class="fa-solid fa-comments"></i></button>
    <button class="chatbot-toggle" id="chatbot-toggle" title="ChatBot" onclick="toggleChatbot()"><i class="fa-solid fa-robot"></i></button>
    <!-- Chat en vivo -->
    <div class="livechat-box" id="livechat-box">
        <div class="livechat-header">
            Chat en Vivo
            <button class="livechat-close" onclick="toggleLiveChat()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div style="padding:0.7rem 1.2rem 0.2rem 1.2rem;">
            <input class="livechat-username" id="livechat-username" type="text" placeholder="Tu nombre o usuario" maxlength="32">
        </div>
        <div class="livechat-messages" id="livechat-messages"></div>
        <form class="livechat-input-area" onsubmit="sendLiveChatMessage(event)">
            <input class="livechat-input" id="livechat-input" type="text" placeholder="Escribe un mensaje..." autocomplete="off" required>
            <button class="livechat-send" type="submit"><i class="fa-solid fa-paper-plane"></i></button>
        </form>
    </div>
    <!-- ChatBot -->
    <div class="chatbot-box" id="chatbot-box">
        <div class="chatbot-header">
            ChatBot
            <button class="chatbot-close" onclick="toggleChatbot()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="chatbot-messages" id="chatbot-messages"></div>
        <form class="chatbot-input-area" onsubmit="sendChatbotMessage(event)">
            <input class="chatbot-input" id="chatbot-input" type="text" placeholder="Pregunta algo..." autocomplete="off" required>
            <button class="chatbot-send" type="submit"><i class="fa-solid fa-paper-plane"></i></button>
        </form>
    </div>
    <script>
    // TECNONAUTA: Chat en Vivo y ChatBot
    function toggleLiveChat() {
        const box = document.getElementById('livechat-box');
        const btn = document.getElementById('livechat-toggle');
        if (box.style.display === 'none' || box.style.display === '') {
            box.style.display = 'flex';
            btn.style.display = 'none';
        } else {
            box.style.display = 'none';
            btn.style.display = 'flex';
        }
    }
    function toggleChatbot() {
        const box = document.getElementById('chatbot-box');
        const btn = document.getElementById('chatbot-toggle');
        if (box.style.display === 'none' || box.style.display === '') {
            box.style.display = 'flex';
            btn.style.display = 'none';
        } else {
            box.style.display = 'none';
            btn.style.display = 'flex';
        }
    }
    // ChatBot: enviar mensaje
    async function sendChatbotMessage(e) {
        e.preventDefault();
        const input = document.getElementById('chatbot-input');
        const messages = document.getElementById('chatbot-messages');
        const userMsg = input.value.trim();
        if (!userMsg) return;
        messages.innerHTML += `<div style='margin-bottom:0.5rem;text-align:right;'><span style='background:var(--light-blue);color:var(--primary-color);padding:0.5rem 1rem;border-radius:14px 14px 2px 14px;display:inline-block;'>${userMsg}</span></div>`;
        input.value = '';
        messages.scrollTop = messages.scrollHeight;
        try {
            const res = await fetch('/chatbot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userMsg })
            });
            const data = await res.json();
            messages.innerHTML += `<div style='margin-bottom:0.5rem;text-align:left;'><span style='background:var(--primary-color);color:var(--light-blue);padding:0.5rem 1rem;border-radius:14px 14px 14px 2px;display:inline-block;'>${data.response}</span></div>`;
            messages.scrollTop = messages.scrollHeight;
        } catch (err) {
            messages.innerHTML += `<div style='margin-bottom:0.5rem;text-align:left;'><span style='background:var(--primary-color);color:var(--light-blue);padding:0.5rem 1rem;border-radius:14px 14px 14px 2px;display:inline-block;'>Error de conexión con el bot.</span></div>`;
        }
    }
    // Chat en Vivo: enviar mensaje (requiere socket.io en backend)
    let socket;
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof io !== 'undefined') {
            socket = io();
            socket.on('receive_message', function(data) {
                const usernameInput = document.getElementById('livechat-username');
                const messages = document.getElementById('livechat-messages');
                const isUser = usernameInput && data.username === usernameInput.value.trim();
                const msgDiv = document.createElement('div');
                msgDiv.className = 'msg' + (isUser ? ' user' : '');
                msgDiv.innerHTML = `<span style='font-size:0.9rem;color:var(--accent-color);margin:0 0.5rem;'>${data.username}</span><span style='max-width:70%;padding:0.7rem 1.1rem;border-radius:16px 16px 2px 16px;background:${isUser ? 'var(--primary-color)' : 'var(--light-blue)'};color:${isUser ? 'var(--light-blue)' : 'var(--primary-color)'};font-weight:500;font-size:1.05rem;box-shadow:0 1px 4px rgba(106, 44, 61, 0.2);display:inline-block;'>${data.message}</span>`;
                messages.appendChild(msgDiv);
                messages.scrollTop = messages.scrollHeight;
            });
        }
    });
    function sendLiveChatMessage(e) {
        e.preventDefault();
        const input = document.getElementById('livechat-input');
        const usernameInput = document.getElementById('livechat-username');
        const msg = input.value.trim();
        const username = usernameInput && usernameInput.value.trim() ? usernameInput.value.trim() : 'Invitado';
        if (!msg || !socket) return;
        socket.emit('send_message', { message: msg, username: username });
        input.value = '';
    }
    </script>
</body>
</html>
