<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard | MenTora</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/usser.css') }}">
</head>
<body>
    {% include 'background_usser.html' %}  
    <nav class="main-navbar">
        <div class="navbar-content">
            <a href="/dashboard" class="navbar-logo">
                <img src="{{ url_for('static', filename='img/mentora1.png') }}" alt="Logo MenTora">
            </a>
            <div class="navbar-user">
                <img src="{{ avatar_url }}" alt="avatar" class="navbar-avatar">
                <span class="navbar-username">{{ username }}</span>
                <button id="userMenuBtn" class="navbar-user-btn">
                    <img src="https://api.iconify.design/mdi/menu.svg?color=%23ffffff" alt="icono men√∫" class="menu-icon">
                </button>

                <div id="userMenu" class="navbar-user-menu">
                    <a href="/edit_profile">PERFIL</a>
                    <a href="#logros">TUS LOGROS</a>
                    <a href="#notificaciones" onclick="scrollToSection('notificaciones')">NOTIFICACIONES</a>
                    <a href="#reto-especial" onclick="scrollToSection('reto-especial')">DESAF√çO DIARIO</a>
                    <a href="#historial" onclick="scrollToSection('historial')">HISTORIAL</a>
                    <a href="#" onclick="showModal();return false;" style="font-weight:700;">CERRAR SESI√ìN</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="filters-section">
            <div class="filters-wrapper">
                <div class="filters">
                     <a href="/dashboard" class="filter-btn active">
                        <img src="https://api.iconify.design/mdi/view-dashboard.svg?color=%236A2C3D" alt="dashboard" style="width: 20px; height: 20px;">
                        DASHBOARD
                    </a>
                    <a href="/games" class="filter-btn">
                        <img src="https://api.iconify.design/mdi/gamepad-variant.svg?color=%236A2C3D" alt="juegos" style="width: 20px; height: 20px;">
                        JUEGOS
                    </a>
                    <a href="/biblioteca" class="filter-btn">
                        <img src="https://api.iconify.design/mdi/book-open-page-variant.svg?color=%236A2C3D" alt="biblioteca" style="width: 20px; height: 20px;">
                        BIBLIOTECA
                    </a>
                    <a href="/noticias" class="filter-btn">
                        <img src="https://api.iconify.design/mdi/newspaper-variant.svg?color=%236A2C3D" alt="noticias" style="width: 20px; height: 20px;">
                        NOTICIAS
                    </a>
                    <a href="/juegos-interactivos" class="filter-btn">
                        <img src="https://api.iconify.design/mdi/puzzle.svg?color=%236A2C3D" alt="zona interactiva" style="width: 20px; height: 20px;">
                        ZONA INTERACTIVA
                    </a>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value">{{ points }}</div>
                <div class="stat-label">PUNTOS</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ level }}</div>
                <div class="stat-label">NIVEL</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ achievements|length }}</div>
                <div class="stat-label">LOGROS</div>
            </div>
        </div>

        <div class="leaderboard glass-card">
        <h2 style="color:#6A2C3D;"> <img src="https://api.iconify.design/mdi/trophy.svg?color=%236A2C3D"
         alt="icono trofeo"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">
          Ranking de L√≠deres </h2>

            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Usuario</th>
                        <th>Nivel</th>
                        <th>Puntos</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in leaderboard %}
                        <tr class="{% if u.username == username %}highlight{% endif %}">
                            <td style="text-align:center;">{{ loop.index }}</td>
                            <td>{{ u.username }}</td>
                            <td style="text-align:center;">{{ u.level }}</td>
                            <td style="text-align:center;">{{ u.points }}</td>
                        </tr>
                    {% else %}
                    <tr><td colspan="4" style="text-align:center; color:#4a3840;">No hay usuarios en el ranking a√∫n.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="level-progress-section glass-card">
          <h2 style="color:#6A2C3D;">
          <img src="https://api.iconify.design/material-symbols/flag.svg?color=%236A2C3D"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">
        Progreso de Nivel </h2>

            <div class="level-progress">
                <div class="level-progress-bar" style="width: {{ progress_percent }}%;"></div>
            </div>
            <div class="level-progress-text">
                Progreso hacia el siguiente nivel: {{ progress_percent }}%
            </div>
        </div>

        <div class="motivational"> Tu actitud es la clave para lograr cualquier cosa que te propongas. <br>
            {{ motivational_message }}
        </div>

        <section id="reto-especial" class="special-section">
            <h2> <img src="https://api.iconify.design/mdi/lightning-bolt.svg?color=%236A2C3D"
         alt="icono target" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">Reto Especial del D√≠a</h2>
            <p style="font-size:1.1rem; margin-bottom:1.5rem;">
                ¬°Participa en el reto especial y gana puntos extra!<br>
                <span style="color:#8A4255;font-weight:bold;">{{ special_challenge.title if special_challenge else 'Pr√≥ximamente...' }}</span>
            </p>
            {% if special_challenge %}
            <form method="GET" action="/quiz/{{ special_challenge.id }}">
                <button type="submit" class="quiz-button">Intentar Reto Especial</button>
            </form>
            {% endif %}
        </section>


        <section id="notificaciones" class="special-section">
            <h2> <img  src="https://api.iconify.design/mdi/bell.svg?color=%236A2C3D"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"> Notificaciones</h2>
            <ul class="notification-list">
                {% if notifications and notifications|length > 0 %}
                    {% for n in notifications %}
                        <li>{{ n.message }} <span style="font-size:0.9em;color:#4a3840;">({{ n.created_at.strftime('%d/%m/%Y %H:%M') }})</span></li>
                    {% endfor %}
                {% else %}
                    <li style="color:#4a3840;">No tienes notificaciones nuevas.</li>
                {% endif %}
            </ul>
        </section>

        <section id="historial" class="special-section">
            <h2> <img src="https://api.iconify.design/mdi/file-document.svg?color=%236A2C3D"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"> Historial de Actividad</h2>
            <ul class="activity-list">
                {% if activity_log and activity_log|length > 0 %}
                    {% for a in activity_log %}
                        <li>{{ a.action }} <span style="font-size:0.9em;color:#4a3840;">({{ a.timestamp.strftime('%d/%m/%Y %H:%M') }})</span></li>
                    {% endfor %}
                {% else %}
                    <li style="color:#4a3840;">No hay actividad reciente.</li>
                {% endif %}
            </ul>
        </section>

        {% if achievements|length > 0 %}
        <div class="insignias-destacadas">
            {% for logro in achievements[:3] %}
            {% if logro.badge and logro.badge.image_url %}
                <img class="insignia-icon" src="{{ logro.badge.image_url }}" alt="{{ logro.badge.name }}" title="{{ logro.badge.name }}">
            {% else %}
                <div class="insignia-icon" title="{{ logro.badge.name if logro.badge else 'Insignia' }}">üèÖ</div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <div class="logros glass-card" id="logros">
            <h2> <img src="https://api.iconify.design/mdi/medal.svg?color=%236A2C3D"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">Tus Logros</h2>
            <div style="display:flex; flex-wrap:wrap; gap:1rem;">
                {% for logro in achievements %}
                <div class="logro-item">
                    {% if logro.badge and logro.badge.image_url %}
                        <img src="{{ logro.badge.image_url }}" alt="{{ logro.badge.name }}" style="width:54px; height:54px; border-radius:50%; border:2px solid #B57386; background:#fff; object-fit:cover; margin-bottom:0.5rem;">
                    {% else %}
                        <div class="insignia-icon" style="width:54px; height:54px; font-size:2rem;" title="{{ logro.badge.name if logro.badge else 'Insignia' }}">üèÖ</div>
                    {% endif %}
                    <h4>{{ logro.badge.name if logro.badge else logro.title }}</h4>
                    <p>{{ logro.badge.description if logro.badge else logro.description }}</p>
                    {% if logro.earned_at %}
                    <span style="font-size:0.85em; color:#4a3840;">Obtenido: {{ logro.earned_at.strftime('%d/%m/%Y') }}</span>
                    {% endif %}
                </div>
                {% else %}
                <p style="color:#4a3840;">No has desbloqueado logros a√∫n.</p>
                {% endfor %}
            </div>
        </div>

        <div class="retos glass-card">
            <h2> <img src="https://api.iconify.design/mdi/brain.svg?color=%236A2C3D"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"> Actividades Asignadas</h2>
            <div style="display:flex; flex-wrap:wrap; gap:1rem;">
                {% set hay_retos = (quizzes and quizzes|length > 0) or (games and games|length > 0) %}
                {% if quizzes and quizzes|length > 0 %}
                    {% for quiz in quizzes %}
                        <div class="reto-item">
                            <h4> {{ quiz.title }}</h4>
                            <p>√Årea: {{ quiz.area }}</p>
                            <form method="GET" action="/quiz/{{ quiz.id }}" style="margin-top:0.7rem;">
                                <button type="submit" class="styled-quiz-btn">Intentar Quiz</button>
                            </form>
                        </div>
                    {% endfor %}
                {% endif %}
                {% if games and games|length > 0 %}
                    {% for game in games %}
                        <div class="reto-item">
                            <h4>{{ game.name }}</h4>
                            <p>Tipo: {{ game.type }}</p>
                            <form method="GET" action="/games/{{ game.id }}" style="margin-top:0.7rem;">
                                <button type="submit" class="styled-quiz-btn">Ver Juego</button>
                            </form>
                        </div>
                    {% endfor %}
                {% endif %}
                {% if not hay_retos %}
                    <p style="color:#4a3840;">No hay retos ni juegos creados por el profesor a√∫n.</p>
                {% endif %}
            </div>
        </div>
       <br>  
        <div style="text-align:center; margin:2rem 0;">
            <a href="/games" class="games-button" style="display:inline-block; text-decoration:none; padding:1rem 2.5rem; font-size:1.2rem;">
                <span style="font-size:1.3rem;"></span> ¬°COMIENZA A JUGAR! </a>
        </div>

        <!-- Secci√≥n de Historial de Actividades -->
        <div class="historial glass-card" id="historial">
            <h2>
                <img src="https://api.iconify.design/mdi/history.svg?color=%236A2C3D" alt="icono historial" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">
                Historial de Actividades
            </h2>
            <div class="historial-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div class="stat-mini-card" style="background: linear-gradient(135deg, rgba(227, 200, 207, 0.3), rgba(181, 115, 134, 0.2)); padding: 1rem; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);">{{ total_quizzes_completed }}</div>
                    <div style="font-size: 0.9rem; color: var(--text-dark);">Quizzes Completados</div>
                </div>
                <div class="stat-mini-card" style="background: linear-gradient(135deg, rgba(227, 200, 207, 0.3), rgba(181, 115, 134, 0.2)); padding: 1rem; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);">{{ total_games_completed }}</div>
                    <div style="font-size: 0.9rem; color: var(--text-dark);">Juegos Completados</div>
                </div>
                <div class="stat-mini-card" style="background: linear-gradient(135deg, rgba(227, 200, 207, 0.3), rgba(181, 115, 134, 0.2)); padding: 1rem; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);">{{ total_points_from_quizzes }}</div>
                    <div style="font-size: 0.9rem; color: var(--text-dark);">Puntos de Quizzes</div>
                </div>
                <div class="stat-mini-card" style="background: linear-gradient(135deg, rgba(227, 200, 207, 0.3), rgba(181, 115, 134, 0.2)); padding: 1rem; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);">{{ total_points_from_games }}</div>
                    <div style="font-size: 0.9rem; color: var(--text-dark);">Puntos de Juegos</div>
                </div>
            </div>
            
            <div class="historial-timeline" style="max-height: 400px; overflow-y: auto;">
                {% if recent_activities and recent_activities|length > 0 %}
                    {% for activity in recent_activities %}
                        <div class="activity-item" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; margin-bottom: 0.8rem; background: rgba(255, 255, 255, 0.5); border-radius: 10px; border-left: 4px solid var(--primary-color);">
                            <div class="activity-icon" style="font-size: 2rem;">
                                {% if activity.activity_type == 'quiz' %}
                                    üìù
                                {% elif activity.activity_type == 'game' %}
                                    üéÆ
                                {% elif activity.activity_type == 'achievement' %}
                                    üèÜ
                                {% else %}
                                    ‚úÖ
                                {% endif %}
                            </div>
                            <div class="activity-details" style="flex: 1;">
                                <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 0.3rem;">
                                    {{ activity.activity_name }}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-dark); margin-bottom: 0.2rem;">
                                    {{ activity.description }}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-gray);">
                                    {{ activity.timestamp.strftime('%d/%m/%Y %H:%M') }}
                                </div>
                            </div>
                            {% if activity.points_earned > 0 %}
                                <div class="activity-points" style="background: linear-gradient(135deg, var(--light-blue), rgba(227, 200, 207, 0.6)); color: var(--primary-color); padding: 0.5rem 1rem; border-radius: 20px; font-weight: 700;">
                                    +{{ activity.points_earned }} pts
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p style="color:#4a3840; text-align: center; padding: 2rem;">No hay actividades registradas a√∫n. ¬°Comienza a completar quizzes y juegos!</p>
                {% endif %}
            </div>
        </div>
    </div>

    <footer class="main-footer">
       <p>¬© 2025 {{ config.SITE_NAME }} - Todos los derechos reservados.</p>
    </footer>

  
    <form id="logoutForm" method="POST" action="/logout">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    </form>

    <div id="logoutModal" class="modal" tabindex="-1">
        <div class="modal-content">
            <h3>¬øCerrar Sesi√≥n?</h3>
            <p>¬øSeguro que quieres salir de MenTora?</p>
            <div style="display:flex; gap:1.2rem; justify-content:center; width:100%;">
                <button class="confirm" onclick="submitLogout(event)">S√≠, cerrar</button>
                <button class="cancel" onclick="hideModal(); return false;">Cancelar</button>
            </div>
        </div>
    </div>

    <audio id="livechat-sound" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae5b6.mp3" preload="auto" style="display:none;"></audio>

    <div id="livechat-container" class="chat-container">
        <div id="livechat-box" class="chat-box">
            <div class="chat-header">
                <span>Chat en Vivo</span>
                <button onclick="toggleLiveChat()">√ó</button>
            </div>
            <div style="padding:0.7rem 1.2rem 0.2rem 1.2rem;">
                <input class="livechat-username" id="livechat-username" type="text" placeholder="Tu nombre o usuario" maxlength="32">
            </div>
            <div id="livechat-messages"></div>
            <form class="chat-input-area" id="livechat-form" autocomplete="off">
                <input id="livechat-input" type="text" placeholder="Escribe un mensaje..." autocomplete="off" required>
                <button type="submit">Enviar</button>
            </form>
        </div>
        <button id="livechat-toggle" class="chat-toggle" onclick="toggleLiveChat()">
            <img src="https://api.iconify.design/bi/chat-dots-fill.svg?color=%23ffffff" alt="chat icon" class="chat-toggle-icon">
        </button>
    </div>

    <div id="chatbot-container" class="chat-container">
        <div id="chatbot-box" class="chat-box">
            <div class="chat-header">
                <span>MenToraBot</span>
                <button type="button" onclick="toggleChatbot()">√ó</button>
            </div>
            <div id="chatbot-messages"></div>
            <form class="chat-input-area" id="chatbot-form">
                <input id="chatbot-input" type="text" placeholder="Escribe tu pregunta..." autocomplete="off">
                <button type="submit">Enviar</button>
            </form>
        </div>
        <button id="chatbot-toggle" class="chat-toggle" type="button" onclick="toggleChatbot()">
            <img src="https://api.iconify.design/bi/robot.svg?color=%23ffffff" alt="robot" class="chat-toggle-icon">
        </button>
    </div>

    <script defer src="{{ url_for('static', filename='js/script_usser.js') }}"></script>
    <script>
        // Inicializar chatbot despu√©s de que el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            const chatForm = document.getElementById('chatbot-form');
            if (chatForm) {
                chatForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const input = document.getElementById('chatbot-input');
                    const messages = document.getElementById('chatbot-messages');
                    
                    if (!input || !messages) return;
                    
                    const userMsg = input.value.trim();
                    if (!userMsg) return;
                    
                    // Mostrar mensaje del usuario
                    messages.innerHTML += `<div style='margin-bottom:0.5rem;text-align:right;'><span style='background:linear-gradient(135deg, #6A2C3D, #8A4255);color:#fff;padding:0.5rem 1rem;border-radius:14px 14px 2px 14px;display:inline-block;box-shadow:0 2px 8px rgba(106,44,61,0.3);'>${userMsg}</span></div>`;
                    input.value = '';
                    messages.scrollTop = messages.scrollHeight;
                    
                    try {
                        const res = await fetch('/chatbot', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: userMsg })
                        });
                        
                        if (!res.ok) {
                            throw new Error('Error en la respuesta del servidor');
                        }
                        
                        const data = await res.json();
                        messages.innerHTML += `<div style='margin-bottom:0.5rem;text-align:left;'><span style='background:linear-gradient(135deg, #f3e5e8, #fef8f9);color:#4a3840;padding:0.5rem 1rem;border-radius:14px 14px 14px 2px;display:inline-block;border:1px solid #d4a5b0;box-shadow:0 2px 8px rgba(106,44,61,0.1);'>${data.response}</span></div>`;
                        messages.scrollTop = messages.scrollHeight;
                    } catch (err) {
                        console.error('Error en chatbot:', err);
                        messages.innerHTML += `<div style='margin-bottom:0.5rem;text-align:left;'><span style='background:#ffe5e5;color:#a03030;padding:0.5rem 1rem;border-radius:14px 14px 14px 2px;display:inline-block;border:1px solid #ffb3b3;'>Error de conexi√≥n con el bot. Por favor, verifica tu conexi√≥n a internet.</span></div>`;
                        messages.scrollTop = messages.scrollHeight;
                    }
                });
            }
        });
    </script>
</body>
</html>