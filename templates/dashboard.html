<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard | MenTora</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@700;900&display=swap" rel="stylesheet">
    
<style>
        /* === RESET Y BASE === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            font-family: 'Poppins', 'Orbitron', Arial, sans-serif;
            background: #5f7f81;
            color: #e0e7ef;
            min-height: 100vh;
            margin: 0;
            letter-spacing: 0.5px;
            overflow-x: hidden;
        }

        /* === SVG BACKGROUND === */
        .circuit-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            pointer-events: none;
            opacity: 0.3;
            filter: blur(1.5px) brightness(1.1);
        }

    /* === NAVIGATION === */
    .main-navbar {
    justify-content: space-between;
    padding: 1rem 2rem;
    background: #5f7f81;
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 32px rgba(0, 0, 0, 0.1);
    font-family: 'Exo 2', sans-serif;
    letter-spacing: 2px;
    position: sticky;
    top: 0;
    height: 80px;     
    padding: 0 2rem; 
    z-index: 90;     
    }

   .navbar-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1400px;
    height: 100%;           
    margin: 0 auto;
    
   }

   /* === LOGO === */
   .navbar-logo {
    padding-top: 8px;
    height: 100%;         
    width: 80px;        
    overflow: hidden;      
     position: relative;
    left: -20px; 
   }

   .navbar-logo img {
    height: 100%;           
    width: auto;           
    object-fit: cover; 
       margin-left: auto;      
   }

   /* === LINKS DEL NAV === */
   .navbar-links {
    display: flex;
    gap: 2rem;
    justify-content: center;
    align-items: center;
    flex: 1;
    list-style: none;
    margin: 0;
    padding: 0;
    
   }

   .navbar-links li {
    list-style: none;
   }

   .navbar-links li a {
    text-decoration: none;
    color: #fff;
    font-size: 1rem;
    font-weight: 600;
    transition: color 0.3s, text-shadow 0.3s;
    letter-spacing: 1px;
   }

  .navbar-links li a:hover,
  .navbar-links li a.active {
    color: #e0ffff;
    text-shadow: 0 0 8px #e0ffff;
   }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
               right: -25px; 
        }

        .navbar-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
        }

        .navbar-username {
            color: #fff;
            font-weight: 600;
               font-family: 'Exo 2', sans-serif;
               text-transform: uppercase; 
        }

        .navbar-user-btn {
            color: #e0ffff;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: transform 0.3s;
        }

        .navbar-user-btn:hover {
            transform: rotate(180deg);
        }

        .navbar-user-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 4.0rem;
            background: rgba(255, 255, 255, 0.98);
            color: #5f7f8185;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(95, 127, 129, 0.3);
            min-width: 220px;
            overflow: hidden;
            z-index: 200;
            backdrop-filter: blur(6px);
            flex-direction: column;
            padding: 0;
        }

        .navbar-user-menu a {
            display: block;
            width: 100%;
            font-family: 'Exo 2', sans-serif;
            padding: 1.1rem 1.5rem;
            text-decoration: none;
            color: #5f7f81;
            font-weight: 600;
            transition: background 0.2s, color 0.2s;
            text-align: left;
        }

        .navbar-user-menu a:last-child {
            border-bottom: none;
        }

        .navbar-user-menu a:hover {
            background: #5f7f81;
            color: #fff;
               left: -20px; 
        }

        /* === CONTAINER === */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2.5rem 1.2rem;
            position: relative;
            z-index: 10;
        }

        /* === GLASS CARDS === */
        .glass-card,
        .special-section {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            color: #114c5f;
            font-family: 'Poppins', sans-serif;
            border-radius: 18px;
            backdrop-filter: blur(10px);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        /* === STATS === */
        .stats {
            display: flex;
            gap: 2rem;
            justify-content: center;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
        }

        .stat-card {
            border: 2px solid #5f7f81;
            background: rgba(255, 255, 255, 0.95);
            color: #114c5f;
            box-shadow: 0 4px 20px rgba(95, 127, 129, 0.3);
            border-radius: 16px;
            transition: transform 0.3s, box-shadow 0.3s;
            min-width: 160px;
            text-align: center;
            padding: 1.5rem 1.2rem;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(95, 127, 129, 0.4);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #114c5f;
            margin-bottom: 0.3rem;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(95, 127, 129, 0.2);
        }

        .stat-label {
            font-size: 1.1rem;
            color: #114c5f;
            font-weight: 600;
            font-family: 'Exo 2', sans-serif;
            letter-spacing: 0.5px;
        }

        /* === TABLES === */
        .leaderboard table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.5rem;
        }

        .leaderboard thead {
            background: #114c5f;
            color: #fff;
        }

        .leaderboard th {
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .leaderboard tbody tr {
            background: rgba(255, 255, 255, 0.6);
            transition: background 0.3s, transform 0.3s;
        }

        .leaderboard tbody tr:hover {
            background: rgba(224, 255, 255, 0.4);
            transform: translateX(5px);
        }

        .leaderboard tbody tr.highlight {
            background:  #5f7f814d;
            font-weight: 600;S
        }

        .leaderboard td {
            padding: 1rem;
            color: #114c5f;
            font-weight: 500;
                    text-align: center;
        }

        /* === PROGRESS BAR === */
        .level-progress {
            background: #e0e7ef;
            border-radius: 12px;
            height: 24px;
            overflow: hidden;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .level-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #5f7f81, #4a6668);
            border-radius: 12px;
            transition: width 0.7s ease;
            box-shadow: 0 2px 6px rgba(95, 127, 129, 0.4);
        }

        .level-progress-text {
            font-size: 1.1rem;
            color: #5f7f81;
            font-weight: 600;
            text-align: center;
        }

        /* === MOTIVATIONAL === */
        .motivational {
            background: #114c5f;
            color: #ffff;
            font-family: 'Exo 2', sans-serif;
            font-size: 1.5rem;
            text-align: center;
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2.5rem;
            font-weight: 600;
            letter-spacing: 1px;
        }

        /* === SECTION TITLES === */
        h2 {
            font-size: 1.8rem;
            color: :#114c5f;
            margin-bottom: 1.5rem;
            font-family: 'Exo 2', sans-serif;
            letter-spacing: 1px;
        }

        /* === BUTTONS === */
        .styled-quiz-btn,
        .games-button,
        .quiz-button,
        .confirm {
            text-decoration: none;
       background: #114c5f 100%;
       color: #ffffffff;
       padding: 1rem 2.5rem;
       border-radius: 30px;
       font-weight: bold;
       font-family: 'Exo 2', sans-serif;
       margin: 0 0.7rem;
       font-size: 1.15rem;
       letter-spacing: 1px;
       border: none;
       transition: background 0.2s, color 0.2s, transform 0.15s, box-shadow 0.2s;
       display: inline-block;
        }

        .styled-quiz-btn:hover,
        .games-button:hover,
        .quiz-button:hover,
        .confirm:hover {
            transform: translateY(-3px);
             background: #5f7f81;
            color: #fff;
        }

        .cancel {
       text-decoration: none;
       background: #114c5f 100%;
       color: #ffffffff;
       padding: 1rem 2.5rem;
       border-radius: 30px;
       font-weight: bold;
       font-family: 'Exo 2', sans-serif;
       margin: 0 0.7rem;
       font-size: 1.15rem;
       letter-spacing: 1px;
       border: none;
       transition: background 0.2s, color 0.2s, transform 0.15s, box-shadow 0.2s;
       display: inline-block;
        }

        .cancel:hover {
            transform: translateY(-3px);
            background: #5f7f81;
            color: #fff;
        }

        /* === INSIGNIAS === */
        .insignias-destacadas {
            display: flex;
            gap: 1.2rem;
            justify-content: center;
            margin-bottom: 2.5rem;
            flex-wrap: wrap;
        }

        .insignia-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 3px solid #5f7f81;
            background: #fff;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(95, 127, 129, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: #5f7f81;
            transition: transform 0.3s;
        }

        .insignia-icon:hover {
            transform: scale(1.1) rotate(10deg);
        }

        /* === RETOS/LOGROS === */
        .reto-item,
        .logro-item {
            flex: 1 1 200px;
            min-width: 200px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #5f7f81;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(95, 127, 129, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 1rem;
        }

        .reto-item:hover,
        .logro-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(95, 127, 129, 0.3);
        }

        .reto-item h4,
        .logro-item h4 {
            color: #5f7f81;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .reto-item p,
        .logro-item p {
            color: #4a6668;
            margin-bottom: 0.5rem;
        }

        /* === LISTS === */
        .notification-list,
        .activity-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .notification-list li,
        .activity-list li {
            color: #4a6668;
            background: rgba(95, 127, 129, 0.1);
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border-left: 4px solid #5f7f81;
        }

        /* === FOOTER === */
        .main-footer {
             background: #114c5f;
            color: #fff;
            font-family: 'Exo 2', sans-serif;
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
            position: relative;
            z-index: 20;
        }

       

        /* === MODAL === */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        .modal:focus {
            outline: none;
        }

        .modal-content {
            background: linear-gradient(135deg, #e0ffff 0%, #fff 100%);
            border-radius: 25px;
            padding: 2.5rem;
            max-width: 420px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 3px solid #5f7f81;
            position: relative;
            margin: auto;
        }

        .modal-content h3 {
            color: #5f7f81;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
            font-family: 'Exo 2', sans-serif;
        }

        .modal-content p {
            color: #4a6668;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        /* === CHAT CONTAINERS === */
        .chat-container {
            position: fixed;
            bottom: 32px;
            z-index: 1000;
        }

        /* CONTENEDOR DEL LIVECHAT */
 #livechat-container {
    position: fixed;
    right: 32px;
    bottom: 120px;   /* <-- M√ÅS ARRIBA */
    z-index: 999;
 }

  /* CONTENEDOR DEL CHATBOT */
  #chatbot-container {
    position: fixed;
    right: 32px;       /* <-- AHORA TAMBI√âN A LA IZQUIERDA */
    bottom: 32px;     /* <-- DEBAJO DEL OTRO */
    z-index: 999;
  }


        #livechat-box,
        #chatbot-box {
            display: none;
            width: 340px;
            max-width: 90vw;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(95, 127, 129, 0.4);
            border: 2px solid #5f7f81;
            overflow: hidden;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, #5f7f81 0%, #4a6668 100%);
            color: #fff;
            padding: 1rem 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-family: 'Exo 2', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }

        .chat-header button {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .livechat-username {
            width: 100%;
            margin-bottom: 0.5rem;
            padding: 0.6rem 0.7rem;
            border-radius: 10px;
            border: 2px solid #5f7f81;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
        }

        #livechat-messages,
        #chatbot-messages {
            height: 260px;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
            color: #4a6668;
            font-family: 'Poppins', sans-serif;
        }

        .chat-input-area {
            display: flex;
            padding: 0.8rem;
            background: #fff;
            border-top: 2px solid #5f7f81;
            align-items: center;
        }

        .chat-input-area input {
            flex: 1;
            padding: 0.7rem;
            border: 2px solid #5f7f81;
            border-radius: 10px;
            margin-right: 0.5rem;
            font-family: 'Poppins', sans-serif;
        }

        .chat-input-area input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(95, 127, 129, 0.3);
        }

        .chat-input-area button {
            background: linear-gradient(135deg, #5f7f81 0%, #4a6668 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 0.7rem 1.2rem;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Exo 2', sans-serif;
        }

        .chat-toggle {
            background: linear-gradient(135deg, #5f7f81 0%, #4a6668 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            box-shadow: 0 4px 16px rgba(95, 127, 129, 0.4);
            font-size: 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(95, 127, 129, 0.6);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .navbar-links {
                display: none;
            }

            .stats {
                flex-direction: column;
                align-items: center;
            }

            .stat-card {
                width: 100%;
                max-width: 300px;
            }

            .leaderboard table {
                font-size: 0.9rem;
            }

            .leaderboard th,
            .leaderboard td {
                padding: 0.6rem;
            }

            .container {
                padding: 1.5rem 1rem;
            }

            #livechat-container,
            #chatbot-container {
                bottom: 20px;
            }

            #livechat-container {
                left: 20px;
            }

            #chatbot-container {
                right: 20px;
            }
        }

        @media (max-width: 480px) {
            .motivational {
                font-size: 1.1rem;
                padding: 1.5rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            .stat-value {
                font-size: 2rem;
            }
        }
        .menu-icon {
        padding-top: 5px;
        width: 30px;   /* AJUSTA AQU√ç EL TAMA√ëO */
        height: 30px;
    }

    .chat-toggle {
    width: 70px;
    height: 70px;
    background: #114c5f; /* tu color */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    box-shadow: 0 0 25px rgba(0, 0, 0, 0.25);
    transition: transform 0.3s ease;
  }

  .chat-toggle:hover {
     transform: scale(1.1) rotate(5deg);
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.8);
  }

  .chat-toggle-icon {
    width: 36px;  /* icono grande */
    height: 36px;
  }


    </style>
</head>
<body>
    <nav class="main-navbar">
        <div class="navbar-content">
            <a href="/dashboard" class="navbar-logo">
               <img src="/static/img/mentora1.png" alt="Logo MenTora">
            </a>
            <ul class="navbar-links">
                <li><a href="/dashboard">DASHBOARD</a></li>
                <li><a href="/games">JUEGOS</a></li>
                <li><a href="/quiz">DESAF√çOS</a></li>
                <li><a href="/biblioteca">BIBLIOTECA</a></li>
                <li><a href="/noticias">NOTICIAS</a></li>
                 <li><a href="/juegos-interactivos">ZONA INTECRACTIVA</a></li>
            </ul>
            <div class="navbar-user">
                <img src="{{ avatar_url }}" alt="avatar" class="navbar-avatar">
                <span class="navbar-username">{{ username }}</span>
                <button id="userMenuBtn" class="navbar-user-btn"> <img src="https://api.iconify.design/mdi/menu.svg?color=%23ffffff" alt="icono men√∫" class="menu-icon"> </button>

                <div id="userMenu" class="navbar-user-menu">
                    <a href="/edit_profile"> PERFIL </a>
                    <a href="#logros"> TUS LOGROS </a>
                    <a href="#notificaciones" onclick="scrollToSection('notificaciones')"> NOTIFICACIONES</a>
                    <a href="#reto-especial" onclick="scrollToSection('reto-especial')"> DESAF√çO DIARIO </a>
                    <a href="#historial" onclick="scrollToSection('historial')">HISTORIAL</a>
                    <a href="#" onclick="showModal();return false;" style=" font-weight:700;">CERRAR SESI√ìN</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value">{{ points }}</div>
                <div class="stat-label">PUNTOS</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ level }}</div>
                <div class="stat-label">NIVEL</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ achievements|length }}</div>
                <div class="stat-label">LOGROS</div>
            </div>
        </div>

        <div class="leaderboard glass-card">
        <h2 style="color:#114c5f;"> <img src="https://api.iconify.design/mdi/trophy.svg?color=%23114c5f" 
         alt="icono trofeo" 
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">
          Ranking de L√≠deres </h2>


            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Usuario</th>
                        <th>Nivel</th>
                        <th>Puntos</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in leaderboard %}
                        {% if not u.is_admin and (not u.teacher_profile) %}
                        <tr class="{% if u.username == username %}highlight{% endif %}">
                            <td style="text-align:center;">{{ loop.index }}</td>
                            <td>{{ u.username }}</td>
                            <td style="text-align:center;">{{ u.level }}</td>
                            <td style="text-align:center;">{{ u.points }}</td>
                        </tr>
                        {% endif %}
                    {% else %}
                    <tr><td colspan="4" style="text-align:center; color:#94a1ac;">No hay usuarios en el ranking a√∫n.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="level-progress-section glass-card">
          <h2 style="color:#114c5f;">
          <img src="https://api.iconify.design/material-symbols/flag.svg?color=%23114c5f"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">
        Progreso de Nivel </h2>

            <div class="level-progress">
                <div class="level-progress-bar" style="width: {{ progress_percent }}%;"></div>
            </div>
            <div class="level-progress-text">
                Progreso hacia el siguiente nivel: {{ progress_percent }}%
            </div>
        </div>

        <div class="motivational"> Tu actitud es la clave para lograr cualquier cosa que te propongas. <br>
            {{ motivational_message }}
        </div>

        <section id="reto-especial" class="special-section">
            <h2> <img src="https://api.iconify.design/mdi/lightning-bolt.svg?color=%23114c5f"
         alt="icono target" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">Reto Especial del D√≠a</h2>
            <p style="font-size:1.1rem; margin-bottom:1.5rem;">
                ¬°Participa en el reto especial y gana puntos extra!<br>
                <span style="color:#5f7f81;font-weight:bold;">{{ special_challenge.title if special_challenge else 'Pr√≥ximamente...' }}</span>
            </p>
            {% if special_challenge %}
            <form method="GET" action="/quiz/{{ special_challenge.id }}">
                <button type="submit" class="quiz-button">Intentar Reto Especial</button>
            </form>
            {% endif %}
        </section>

        <!-- Notificaciones -->
        <section id="notificaciones" class="special-section">
            <h2> <img  src="https://api.iconify.design/mdi/bell.svg?color=%23114c5f"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"> Notificaciones</h2>
            <ul class="notification-list">
                {% if notifications and notifications|length > 0 %}
                    {% for n in notifications %}
                        <li>{{ n.message }} <span style="font-size:0.9em;color:#94a1ac;">({{ n.created_at.strftime('%d/%m/%Y %H:%M') }})</span></li>
                    {% endfor %}
                {% else %}
                    <li style="color:#94a1ac;">No tienes notificaciones nuevas.</li>
                {% endif %}
            </ul>
        </section>

        <!-- Historial de Actividad -->
        <section id="historial" class="special-section">
            <h2> <img src="https://api.iconify.design/mdi/file-document.svg?color=%23114c5f"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"> Historial de Actividad</h2>
            <ul class="activity-list">
                {% if activity_log and activity_log|length > 0 %}
                    {% for a in activity_log %}
                        <li>{{ a.action }} <span style="font-size:0.9em;color:#94a1ac;">({{ a.timestamp.strftime('%d/%m/%Y %H:%M') }})</span></li>
                    {% endfor %}
                {% else %}
                    <li style="color:#94a1ac;">No hay actividad reciente.</li>
                {% endif %}
            </ul>
        </section>

        <!-- Insignias destacadas -->
        {% if achievements|length > 0 %}
        <div class="insignias-destacadas">
            {% for logro in achievements[:3] %}
            {% if logro.badge and logro.badge.image_url %}
                <img class="insignia-icon" src="{{ logro.badge.image_url }}" alt="{{ logro.badge.name }}" title="{{ logro.badge.name }}">
            {% else %}
                <div class="insignia-icon" title="{{ logro.badge.name if logro.badge else 'Insignia' }}">üèÖ</div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <div class="logros glass-card" id="logros">
            <h2> <img src="https://api.iconify.design/mdi/medal.svg?color=%23114c5f"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">Tus Logros</h2>
            <div style="display:flex; flex-wrap:wrap; gap:1rem;">
                {% for logro in achievements %}
                <div class="logro-item">
                    {% if logro.badge and logro.badge.image_url %}
                        <img src="{{ logro.badge.image_url }}" alt="{{ logro.badge.name }}" style="width:54px; height:54px; border-radius:50%; border:2px solid #5f7f81; background:#fff; object-fit:cover; margin-bottom:0.5rem;">
                    {% else %}
                        <div class="insignia-icon" style="width:54px; height:54px; font-size:2rem;" title="{{ logro.badge.name if logro.badge else 'Insignia' }}">üèÖ</div>
                    {% endif %}
                    <h4>{{ logro.badge.name if logro.badge else logro.title }}</h4>
                    <p>{{ logro.badge.description if logro.badge else logro.description }}</p>
                    {% if logro.earned_at %}
                    <span style="font-size:0.85em; color:#94a1ac;">Obtenido: {{ logro.earned_at.strftime('%d/%m/%Y') }}</span>
                    {% endif %}
                </div>
                {% else %}
                <p style="color:#94a1ac;">No has desbloqueado logros a√∫n.</p>
                {% endfor %}
            </div>
        </div>

        <div class="retos glass-card">
            <h2> <img src="https://api.iconify.design/mdi/brain.svg?color=%23114c5f"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"> Actividades Asignadas</h2>
            <div style="display:flex; flex-wrap:wrap; gap:1rem;">
                {% set hay_retos = (quizzes and quizzes|length > 0) or (games and games|length > 0) %}
                {% if quizzes and quizzes|length > 0 %}
                    {% for quiz in quizzes %}
                        <div class="reto-item">
                            <h4> {{ quiz.title }}</h4>
                            <p>√Årea: {{ quiz.area }}</p>
                            <form method="GET" action="/quiz/{{ quiz.id }}" style="margin-top:0.7rem;">
                                <button type="submit" class="styled-quiz-btn">Intentar Quiz</button>
                            </form>
                        </div>
                    {% endfor %}
                {% endif %}
                {% if games and games|length > 0 %}
                    {% for game in games %}
                        <div class="reto-item">
                            <h4>{{ game.name }}</h4>
                            <p>Tipo: {{ game.type }}</p>
                            <form method="GET" action="/games/{{ game.id }}" style="margin-top:0.7rem;">
                                <button type="submit" class="styled-quiz-btn">Ver Juego</button>
                            </form>
                        </div>
                    {% endfor %}
                {% endif %}
                {% if not hay_retos %}
                    <p style="color:#94a1ac;">No hay retos ni juegos creados por el profesor a√∫n.</p>
                {% endif %}
            </div>
        </div>
       <br>  
        <div style="text-align:center; margin:2rem 0;">
            <a href="/games" class="games-button" style="display:inline-block; text-decoration:none; padding:1rem 2.5rem; font-size:1.2rem;">
                <span style="font-size:1.3rem;"></span> ¬°COMIENZA A JUGAR! </a>
        </div>
    </div>

    <footer class="main-footer">
       <p>¬© 2025 {{ config.SITE_NAME }} - Todos los derechos reservados.</p>
    </footer>

  
    <form id="logoutForm" method="POST" action="/logout"></form>

    <div id="logoutModal" class="modal" tabindex="-1">
        <div class="modal-content">
            <h3>¬øCerrar Sesi√≥n?</h3>
            <p>¬øSeguro que quieres salir de MenTora?</p>
            <div style="display:flex; gap:1.2rem; justify-content:center; width:100%;">
                <button class="confirm" onclick="submitLogout(event)">S√≠, cerrar</button>
                <button class="cancel" onclick="hideModal(); return false;">Cancelar</button>
            </div>
        </div>
    </div>

    <audio id="livechat-sound" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae5b6.mp3" preload="auto" style="display:none;"></audio>

    <div id="livechat-container" class="chat-container">
        <div id="livechat-box" class="chat-box">
            <div class="chat-header">
                <span>Chat en Vivo</span>
                <button onclick="toggleLiveChat()">√ó</button>
            </div>
            <div style="padding:0.7rem 1.2rem 0.2rem 1.2rem;">
                <input class="livechat-username" id="livechat-username" type="text" placeholder="Tu nombre o usuario" maxlength="32">
            </div>
            <div id="livechat-messages"></div>
            <form class="chat-input-area" id="livechat-form" autocomplete="off">
                <input id="livechat-input" type="text" placeholder="Escribe un mensaje..." autocomplete="off" required>
                <button type="submit">Enviar</button>
            </form>
        </div>
        <button id="livechat-toggle" class="chat-toggle" onclick="toggleLiveChat()">
    <img src="https://api.iconify.design/bi/chat-dots-fill.svg?color=%23ffffff"
         alt="chat icon"
         class="chat-toggle-icon">
</button>

    </div>

    <div id="chatbot-container" class="chat-container">
        <div id="chatbot-box" class="chat-box">
            <div class="chat-header">
                <span>MenToraBot</span>
                <button onclick="toggleChatbot()">√ó</button>
            </div>
            <div id="chatbot-messages"></div>
            <form class="chat-input-area" id="chatbot-form" onsubmit="sendChatbotMessage(event)">
                <input id="chatbot-input" type="text" placeholder="Escribe tu pregunta..." autocomplete="off">
                <button type="submit">Enviar</button>
            </form>
        </div>
        <button id="chatbot-toggle" class="chat-toggle" onclick="toggleChatbot()">
    <img src="https://api.iconify.design/bi/robot.svg?color=%23ffffff"
         alt="robot"
         class="chat-toggle-icon">
   </button>

    </div>

    <script>
        // Evitar cache del navegador
        if (window.performance && window.performance.navigation && window.performance.navigation.type === 2) {
            window.location.reload();
        }

        // Men√∫ desplegable usuario
        const userMenuBtn = document.getElementById('userMenuBtn');
        const userMenu = document.getElementById('userMenu');
        
        if (userMenuBtn && userMenu) {
            userMenuBtn.onclick = function(e) {
                e.stopPropagation();
                userMenu.style.display = userMenu.style.display === 'flex' ? 'none' : 'flex';
            };
            
            document.body.addEventListener('click', function() {
                userMenu.style.display = 'none';
            });
            
            userMenu.onclick = function(e) {
                e.stopPropagation();
            };
        }

        // Scroll a secci√≥n
        function scrollToSection(id) {
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({behavior:'smooth', block:'start'});
                if (userMenu) userMenu.style.display = 'none';
            }
        }

        // Modal functions
        function showModal() {
            const modal = document.getElementById('logoutModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.focus();
            }
        }

        function hideModal() {
            const modal = document.getElementById('logoutModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function submitLogout(e) {
            e.preventDefault();
            const form = document.getElementById('logoutForm');
            if (form) form.submit();
        }

        // Cerrar modal con Escape o clic fuera
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') hideModal();
        });

        const logoutModal = document.getElementById('logoutModal');
        if (logoutModal) {
            logoutModal.addEventListener('click', function(e) {
                if (e.target === this) hideModal();
            });
        }

        // Chat en Vivo: abrir/cerrar
        function toggleLiveChat() {
            const box = document.getElementById('livechat-box');
            const btn = document.getElementById('livechat-toggle');
            if (box && btn) {
                if (box.style.display === 'none' || box.style.display === '') {
                    box.style.display = 'flex';
                    btn.style.display = 'none';
                } else {
                    box.style.display = 'none';
                    btn.style.display = 'flex';
                }
            }
        }

        // Chatbot: abrir/cerrar
        function toggleChatbot() {
            const box = document.getElementById('chatbot-box');
            const btn = document.getElementById('chatbot-toggle');
            if (box && btn) {
                if (box.style.display === 'none' || box.style.display === '') {
                    box.style.display = 'flex';
                    btn.style.display = 'none';
                } else {
                    box.style.display = 'none';
                    btn.style.display = 'flex';
                }
            }
        }

        // Chatbot: enviar mensaje
        async function sendChatbotMessage(e) {
            e.preventDefault();
            const input = document.getElementById('chatbot-input');
            const messages = document.getElementById('chatbot-messages');
            
            if (!input || !messages) return;
            
            const userMsg = input.value.trim();
            if (!userMsg) return;
            
            messages.innerHTML += `<div style='margin-bottom:0.5rem;text-align:right;'><span style='background:#5f7f81;color:#fff;padding:0.5rem 1rem;border-radius:14px 14px 2px 14px;display:inline-block;'>${userMsg}</span></div>`;
            input.value = '';
            messages.scrollTop = messages.scrollHeight;
            
            // Llamar al backend
            try {
                const res = await fetch('/chatbot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userMsg })
                });
                const data = await res.json();
                messages.innerHTML += `<div style='margin-bottom:0.5rem;text-align:left;'><span style='background:#e0ffff;color:#4a6668;padding:0.5rem 1rem;border-radius:14px 14px 14px 2px;display:inline-block;'>${data.response}</span></div>`;
                messages.scrollTop = messages.scrollHeight;
            } catch (err) {
                messages.innerHTML += `<div style='margin-bottom:0.5rem;text-align:left;'><span style='background:#e0ffff;color:#4a6668;padding:0.5rem 1rem;border-radius:14px 14px 14px 2px;display:inline-block;'>Error de conexi√≥n con el bot.</span></div>`;
            }
        }

        // Inicializar socket.io para chat en vivo
        let socket;
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof io !== 'undefined') {
                socket = io();
                socket.on('receive_message', function(data) {
                    const usernameInput = document.getElementById('livechat-username');
                    const messages = document.getElementById('livechat-messages');
                    
                    if (!messages) return;
                    
                    const isUser = usernameInput && data.username === usernameInput.value.trim();
                    const msgDiv = document.createElement('div');
                    msgDiv.style.marginBottom = '0.5rem';
                    msgDiv.style.textAlign = isUser ? 'right' : 'left';
                    msgDiv.innerHTML = `<span style='font-size:0.9rem;color:#94a1ac;margin:0 0.5rem;'>${data.username}</span><span style='max-width:70%;padding:0.7rem 1.1rem;border-radius:16px;background:${isUser ? '#5f7f81' : '#e0ffff'};color:${isUser ? '#fff' : '#4a6668'};font-weight:500;font-size:1.05rem;box-shadow:0 1px 4px rgba(0,0,0,0.1);display:inline-block;'>${data.message}</span>`;
                    messages.appendChild(msgDiv);
                    messages.scrollTop = messages.scrollHeight;
                    
                    // Sonido solo si el mensaje es de otro usuario
                    if (!isUser) {
                        const sound = document.getElementById('livechat-sound');
                        if (sound) {
                            sound.currentTime = 0;
                            sound.play().catch(()=>{});
                        }
                    }
                });
            }

            // Chat en Vivo: enviar mensaje
            const livechatForm = document.getElementById('livechat-form');
            if (livechatForm && typeof io !== 'undefined') {
                livechatForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const input = document.getElementById('livechat-input');
                    const usernameInput = document.getElementById('livechat-username');
                    
                    if (!input || !socket) return;
                    
                    const msg = input.value.trim();
                    const username = usernameInput && usernameInput.value.trim() ? usernameInput.value.trim() : 'Invitado';
                    
                    if (!msg) return;
                    
                    socket.emit('send_message', { message: msg, username: username });
                    input.value = '';
                });
            }
        });
    </script>
</body>
</html>