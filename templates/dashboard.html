<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard | MenTora</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/usser.css') }}">
</head>
<body>
    {% include 'background_usser.html' %}  
    
    <div class="container">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value">{{ points }}</div>
                <div class="stat-label">PUNTOS</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ level }}</div>
                <div class="stat-label">NIVEL</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ achievements|length }}</div>
                <div class="stat-label">LOGROS</div>
            </div>
        </div>

        <div class="leaderboard glass-card">
        <h2 style="color:#6A2C3D;"> <img src="https://api.iconify.design/mdi/trophy.svg?color=%236A2C3D"
         alt="icono trofeo"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">
          Ranking de L√≠deres </h2>

            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Usuario</th>
                        <th>Nivel</th>
                        <th>Puntos</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in leaderboard %}
                        {% if not u.is_admin and (not u.teacher_profile) %}
                        <tr class="{% if u.username == username %}highlight{% endif %}">
                            <td style="text-align:center;">{{ loop.index }}</td>
                            <td>{{ u.username }}</td>
                            <td style="text-align:center;">{{ u.level }}</td>
                            <td style="text-align:center;">{{ u.points }}</td>
                        </tr>
                        {% endif %}
                    {% else %}
                    <tr><td colspan="4" style="text-align:center; color:#4a3840;">No hay usuarios en el ranking a√∫n.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="level-progress-section glass-card">
          <h2 style="color:#6A2C3D;">
          <img src="https://api.iconify.design/material-symbols/flag.svg?color=%236A2C3D"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">
        Progreso de Nivel </h2>

            <div class="level-progress">
                <div class="level-progress-bar" style="width: {{ progress_percent }}%;"></div>
            </div>
            <div class="level-progress-text">
                Progreso hacia el siguiente nivel: {{ progress_percent }}%
            </div>
        </div>

        <div class="motivational"> Tu actitud es la clave para lograr cualquier cosa que te propongas. <br>
            {{ motivational_message }}
        </div>

        <section id="reto-especial" class="special-section">
            <h2> <img src="https://api.iconify.design/mdi/lightning-bolt.svg?color=%236A2C3D"
         alt="icono target" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">Reto Especial del D√≠a</h2>
            <p style="font-size:1.1rem; margin-bottom:1.5rem;">
                ¬°Participa en el reto especial y gana puntos extra!<br>
                <span style="color:#8A4255;font-weight:bold;">{{ special_challenge.title if special_challenge else 'Pr√≥ximamente...' }}</span>
            </p>
            {% if special_challenge %}
            <form method="GET" action="/quiz/{{ special_challenge.id }}">
                <button type="submit" class="quiz-button">Intentar Reto Especial</button>
            </form>
            {% endif %}
        </section>


        <section id="notificaciones" class="special-section">
            <h2> <img  src="https://api.iconify.design/mdi/bell.svg?color=%236A2C3D"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"> Notificaciones</h2>
            <ul class="notification-list">
                {% if notifications and notifications|length > 0 %}
                    {% for n in notifications %}
                        <li>{{ n.message }} <span style="font-size:0.9em;color:#4a3840;">({{ n.created_at.strftime('%d/%m/%Y %H:%M') }})</span></li>
                    {% endfor %}
                {% else %}
                    <li style="color:#4a3840;">No tienes notificaciones nuevas.</li>
                {% endif %}
            </ul>
        </section>

        <section id="historial" class="special-section">
            <h2> <img src="https://api.iconify.design/mdi/file-document.svg?color=%236A2C3D"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"> Historial de Actividad</h2>
            <ul class="activity-list">
                {% if activity_log and activity_log|length > 0 %}
                    {% for a in activity_log %}
                        <li>{{ a.action }} <span style="font-size:0.9em;color:#4a3840;">({{ a.timestamp.strftime('%d/%m/%Y %H:%M') }})</span></li>
                    {% endfor %}
                {% else %}
                    <li style="color:#4a3840;">No hay actividad reciente.</li>
                {% endif %}
            </ul>
        </section>

        {% if achievements|length > 0 %}
        <div class="insignias-destacadas">
            {% for logro in achievements[:3] %}
            {% if logro.badge and logro.badge.image_url %}
                <img class="insignia-icon" src="{{ logro.badge.image_url }}" alt="{{ logro.badge.name }}" title="{{ logro.badge.name }}">
            {% else %}
                <div class="insignia-icon" title="{{ logro.badge.name if logro.badge else 'Insignia' }}">üèÖ</div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <div class="logros glass-card" id="logros">
            <h2> <img src="https://api.iconify.design/mdi/medal.svg?color=%236A2C3D"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">Tus Logros</h2>
            <div style="display:flex; flex-wrap:wrap; gap:1rem;">
                {% for logro in achievements %}
                <div class="logro-item">
                    {% if logro.badge and logro.badge.image_url %}
                        <img src="{{ logro.badge.image_url }}" alt="{{ logro.badge.name }}" style="width:54px; height:54px; border-radius:50%; border:2px solid #B57386; background:#fff; object-fit:cover; margin-bottom:0.5rem;">
                    {% else %}
                        <div class="insignia-icon" style="width:54px; height:54px; font-size:2rem;" title="{{ logro.badge.name if logro.badge else 'Insignia' }}">üèÖ</div>
                    {% endif %}
                    <h4>{{ logro.badge.name if logro.badge else logro.title }}</h4>
                    <p>{{ logro.badge.description if logro.badge else logro.description }}</p>
                    {% if logro.earned_at %}
                    <span style="font-size:0.85em; color:#4a3840;">Obtenido: {{ logro.earned_at.strftime('%d/%m/%Y') }}</span>
                    {% endif %}
                </div>
                {% else %}
                <p style="color:#4a3840;">No has desbloqueado logros a√∫n.</p>
                {% endfor %}
            </div>
        </div>

        <div class="retos glass-card">
            <h2> <img src="https://api.iconify.design/mdi/brain.svg?color=%236A2C3D"
         alt="icono target"
         style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;"> Actividades Asignadas</h2>
            <div style="display:flex; flex-wrap:wrap; gap:1rem;">
                {% set hay_retos = (quizzes and quizzes|length > 0) or (games and games|length > 0) %}
                {% if quizzes and quizzes|length > 0 %}
                    {% for quiz in quizzes %}
                        <div class="reto-item">
                            <h4> {{ quiz.title }}</h4>
                            <p>√Årea: {{ quiz.area }}</p>
                            <form method="GET" action="/quiz/{{ quiz.id }}" style="margin-top:0.7rem;">
                                <button type="submit" class="styled-quiz-btn">Intentar Quiz</button>
                            </form>
                        </div>
                    {% endfor %}
                {% endif %}
                {% if games and games|length > 0 %}
                    {% for game in games %}
                        <div class="reto-item">
                            <h4>{{ game.name }}</h4>
                            <p>Tipo: {{ game.type }}</p>
                            <form method="GET" action="/games/{{ game.id }}" style="margin-top:0.7rem;">
                                <button type="submit" class="styled-quiz-btn">Ver Juego</button>
                            </form>
                        </div>
                    {% endfor %}
                {% endif %}
                {% if not hay_retos %}
                    <p style="color:#4a3840;">No hay retos ni juegos creados por el profesor a√∫n.</p>
                {% endif %}
            </div>
        </div>
       <br>  
        <div style="text-align:center; margin:2rem 0;">
            <a href="/games" class="games-button" style="display:inline-block; text-decoration:none; padding:1rem 2.5rem; font-size:1.2rem;">
                <span style="font-size:1.3rem;"></span> ¬°COMIENZA A JUGAR! </a>
        </div>
    </div>

    <footer class="main-footer">
       <p>¬© 2025 {{ config.SITE_NAME }} - Todos los derechos reservados.</p>
    </footer>

  
    <form id="logoutForm" method="POST" action="/logout"></form>

    <div id="logoutModal" class="modal" tabindex="-1">
        <div class="modal-content">
            <h3>¬øCerrar Sesi√≥n?</h3>
            <p>¬øSeguro que quieres salir de MenTora?</p>
            <div style="display:flex; gap:1.2rem; justify-content:center; width:100%;">
                <button class="confirm" onclick="submitLogout(event)">S√≠, cerrar</button>
                <button class="cancel" onclick="hideModal(); return false;">Cancelar</button>
            </div>
        </div>
    </div>

    <audio id="livechat-sound" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae5b6.mp3" preload="auto" style="display:none;"></audio>

    <div id="livechat-container" class="chat-container">
        <div id="livechat-box" class="chat-box">
            <div class="chat-header">
                <span>Chat en Vivo</span>
                <button onclick="toggleLiveChat()">√ó</button>
            </div>
            <div style="padding:0.7rem 1.2rem 0.2rem 1.2rem;">
                <input class="livechat-username" id="livechat-username" type="text" placeholder="Tu nombre o usuario" maxlength="32">
            </div>
            <div id="livechat-messages"></div>
            <form class="chat-input-area" id="livechat-form" autocomplete="off">
                <input id="livechat-input" type="text" placeholder="Escribe un mensaje..." autocomplete="off" required>
                <button type="submit">Enviar</button>
            </form>
        </div>
        <button id="livechat-toggle" class="chat-toggle" onclick="toggleLiveChat()">
            <img src="https://api.iconify.design/bi/chat-dots-fill.svg?color=%23ffffff" alt="chat icon" class="chat-toggle-icon">
        </button>
    </div>

    <div id="chatbot-container" class="chat-container">
        <div id="chatbot-box" class="chat-box">
            <div class="chat-header">
                <span>MenToraBot</span>
                <button onclick="toggleChatbot()">√ó</button>
            </div>
            <div id="chatbot-messages"></div>
            <form class="chat-input-area" id="chatbot-form" onsubmit="sendChatbotMessage(event)">
                <input id="chatbot-input" type="text" placeholder="Escribe tu pregunta..." autocomplete="off">
                <button type="submit">Enviar</button>
            </form>
        </div>
        <button id="chatbot-toggle" class="chat-toggle" onclick="toggleChatbot()">
            <img src="https://api.iconify.design/bi/robot.svg?color=%23ffffff" alt="robot" class="chat-toggle-icon">
        </button>
    </div>

    <script defer src="{{ url_for('static', filename='js/script_usser.js') }}"></script>
</body>
</html>